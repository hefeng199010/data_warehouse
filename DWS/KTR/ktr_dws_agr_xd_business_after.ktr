<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>ktr_dws_agr_xd_business_after</name>
    <description/>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection/>
        <schema/>
        <table/>
        <size_limit_lines/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject/>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject/>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject/>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject/>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject/>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection/>
        <schema/>
        <table/>
        <interval/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection/>
        <schema/>
        <table/>
        <timeout_days/>
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection/>
      <table/>
      <field/>
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file/>
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2018/01/27 10:21:33.390</created_date>
    <modified_user>-</modified_user>
    <modified_date>2018/01/27 10:21:33.390</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <connection>
    <name>dwd_data</name>
    <server>${UAT_DC_DB_HOST}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${UAT_DC_DB_DWD_NAME}</database>
    <port>3306</port>
    <username>${UAT_DC_DB_USER}</username>
    <password>${UAT_DC_DB_PWD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.characterEncoding</code>
        <attribute>utf8</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>DWS_DATA</name>
    <server>${UAT_DC_DB_HOST}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${UAT_DC_DB_DWS_NAME}</database>
    <port>3306</port>
    <username>${UAT_DC_DB_USER}</username>
    <password>${UAT_DC_DB_PWD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.characterEncoding</code>
        <attribute>utf8</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>线下表数据输入</from>
      <to>表输出</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>线上表数据输入</from>
      <to>表输出</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>线上表数据输入</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>dwd_data</connection>
    <sql>select 
tcba.car_business_id AS business_id,
CASE WHEN xd.is_extension = 1 THEN tcba.car_business_after_defer ELSE tcba.car_business_id end ext_business_id,-- [业务编号，即原业务则是原业务编号，展期业务则是展期业务编号]
tcba.car_business_after_id AS cur_repay_period,
tcba.paratype as business_type,
xd.is_extension as is_defer,
tcba.car_business_after_defer as business_defer_id,
tcba.car_business_defer_id as cur_defer_id,
'1' as is_issue, -- 是否上标，1：是，:0：否
xd.customer_id,
xd.input_time,
tibd.issue_id as issue_id,
tcba.repayment_type as repay_type,
tcba.car_business_after_type as repay_status_type,
tcba.reserve_2 as repay_status_subtype,
tcba.repayed_flag as repayed_type,
tibd.fee_id,
tibd.fee_name,
tibd.after_fee_type as fee_type,
tcba.overdueDays as ovd_days,
tcba.workflowstatus,
tcba.is_collection,
tcba.collectionDate as collection_Date,
tcba.collection_user as collection_usr,
tcba.payment_type,
tcba.out_id,
tcba.is_loss_settle,
tcba.confirm_flag as fin_confirm_flag,
tcba.finance_confirmed_date as fin_confirmed_date,
tcba.finance_confirmed_user as fin_confirmed_usr,
tcba.auto_withholding_confirmed_date as fin_auto_whd_confirmed_date,
tcba.auto_withholding_confirmed_user as fin_auto_whd_confirmed_usr,
tcba.finance_bank_id as fin_bank_id,
tcba.accountant_confirm_status as acct_confirm_status,
tcba.accountant_confirm_user as acct_confirm_usr,
tcba.accountant_confirm_date as acct_confirm_date,
tcba.tuandai_advance_status,
tcba.tuandai_profit_status,
tcba.tuandai_distribute_fund_status,
tcba.tuandai_distribute_fund_remark,
tcba.issue_after_type,
tcba.business_after_guid,
tcba.tracking_after_type,
tibd.plan_repayment_date as shd_repay_date,
tibd.actual_repayment_date as act_replay_Date,
tcba.borrow_money,
tcba.oddcorpus,
tibd.plan_fee_value as shd_amt,
tibd.actual_fee_value as act_amt,
tibd.create_user as create_usr,
tibd.update_user as modify_usr,
tibd.create_time as create_time,
tibd.update_time as modify_time ,
'1' as Is_Valid,
'tuandai_bm'	as	dw_src_sys	,--	来源系统
'DWD_DATA.dwd_agr_xd_car_business_after,DWS_DATA.dws_agr_xd_business,DWD_DATA.dwd_agr_xd_issue_business_after_detail..'	as	dw_src_tbl	,--	来源表
now()	as	dw_ins_tm	,--	插入时间
now()	as	dw_upd_tm	,--	更新时间
'dailiang'	as	dw_ins_usr	,--	插入用户
'dailiang'	as	dw_upd_usr	,--	更新用户
DATE_FORMAT('${pt_day}','%Y-%m-%d')	as	part_dt	--	分区日期
from DWD_DATA.dwd_agr_xd_car_business_after tcba
left join DWS_DATA.dws_agr_xd_business xd
       on tcba.car_business_id = xd.business_id
	  and xd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
left join DWD_DATA.dwd_agr_xd_issue_business_after_detail  tibd	 
       on tcba.car_business_id = tibd.business_id
	  and tcba.car_business_after_id = tibd.business_after_id  
	  and tibd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
where tcba.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
  and IFNULL(xd.issue_type,0) = 1
  and tibd.business_id is not null
 
 union all
 -- （tb_issue_business_after_detail于2017年7月上线，tb_car_business_after7月之前的数据没有导入tb_issue_business_after_detail，这里手动导入本金和利息）
 -- 本金
 select 
tcba.car_business_id AS business_id,
CASE WHEN xd.is_extension = 1 THEN tcba.car_business_after_defer ELSE tcba.car_business_id end ext_business_id,-- [业务编号，即原业务则是原业务编号，展期业务则是展期业务编号]
tcba.car_business_after_id AS cur_repay_period,
tcba.paratype as business_type,
xd.is_extension as is_defer,
tcba.car_business_after_defer as business_defer_id,
tcba.car_business_defer_id as cur_defer_id,
'1' as is_issue, -- 是否上标，1：是，:0：否
xd.customer_id,
xd.input_time,
'' as issue_id,
tcba.repayment_type as repay_type,
tcba.car_business_after_type as repay_status_type,
tcba.reserve_2 as repay_status_subtype,
tcba.repayed_flag as repayed_type,
'b69a84dc-ed67-4c9f-80bf-89ee8efd5167' as fee_id,
'本金' as fee_name,
1 as fee_type,
tcba.overdueDays as ovd_days,
tcba.workflowstatus,
tcba.is_collection,
tcba.collectionDate as collection_Date,
tcba.collection_user as collection_usr,
tcba.payment_type,
tcba.out_id,
tcba.is_loss_settle,
tcba.confirm_flag as fin_confirm_flag,
tcba.finance_confirmed_date as fin_confirmed_date,
tcba.finance_confirmed_user as fin_confirmed_usr,
tcba.auto_withholding_confirmed_date as fin_auto_whd_confirmed_date,
tcba.auto_withholding_confirmed_user as fin_auto_whd_confirmed_usr,
tcba.finance_bank_id as fin_bank_id,
tcba.accountant_confirm_status as acct_confirm_status,
tcba.accountant_confirm_user as acct_confirm_usr,
tcba.accountant_confirm_date as acct_confirm_date,
tcba.tuandai_advance_status,
tcba.tuandai_profit_status,
tcba.tuandai_distribute_fund_status,
tcba.tuandai_distribute_fund_remark,
tcba.issue_after_type,
tcba.business_after_guid,
tcba.tracking_after_type,
tcba.borrow_date as shd_repay_date,
tcba.fatct_replayDate as act_replay_Date,
tcba.borrow_money,
tcba.oddcorpus,
tcba.current_Principa as shd_amt,
tcba.fact_principa as act_amt,
tcba.operator_name as create_usr,
tcba.operator_name as modify_usr,
tcba.create_time as create_time,
tcba.modify_time as modify_time ,
'1' as Is_Valid,
'tuandai_bm'	as	dw_src_sys	,--	来源系统
'DWD_DATA.dwd_agr_xd_car_business_after,DWS_DATA.dws_agr_xd_business,DWD_DATA.dwd_agr_xd_issue_business_after_detail..'	as	dw_src_tbl	,--	来源表
now()	as	dw_ins_tm	,--	插入时间
now()	as	dw_upd_tm	,--	更新时间
'dailiang'	as	dw_ins_usr	,--	插入用户
'dailiang'	as	dw_upd_usr	,--	更新用户
DATE_FORMAT('${pt_day}','%Y-%m-%d')	as	part_dt	--	分区日期
from DWD_DATA.dwd_agr_xd_car_business_after tcba
left join DWS_DATA.dws_agr_xd_business xd
       on tcba.car_business_id = xd.business_id
	  and xd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
left join DWD_DATA.dwd_agr_xd_issue_business_after_detail  tibd	 
       on tcba.car_business_id = tibd.business_id
	  and tcba.car_business_after_id = tibd.business_after_id  
	  and tibd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
where tcba.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
  and IFNULL(xd.issue_type,0) = 1
  and tibd.business_id is null
 union all
 
 -- 利息
 select 
tcba.car_business_id AS business_id,
CASE WHEN xd.is_extension = 1 THEN tcba.car_business_after_defer ELSE tcba.car_business_id end ext_business_id,-- [业务编号，即原业务则是原业务编号，展期业务则是展期业务编号]
tcba.car_business_after_id AS cur_repay_period,
tcba.paratype as business_type,
xd.is_extension as is_defer,
tcba.car_business_after_defer as business_defer_id,
tcba.car_business_defer_id as cur_defer_id,
'1' as is_issue, -- 是否上标，1：是，:0：否
xd.customer_id,
xd.input_time,
'' as issue_id,
tcba.repayment_type as repay_type,
tcba.car_business_after_type as repay_status_type,
tcba.reserve_2 as repay_status_subtype,
tcba.repayed_flag as repayed_type,
'556bce4f-f3a9-4b7a-a8b1-43368bebb49c' as fee_id,
'利息' as fee_name,
2 as fee_type,
tcba.overdueDays as ovd_days,
tcba.workflowstatus,
tcba.is_collection,
tcba.collectionDate as collection_Date,
tcba.collection_user as collection_usr,
tcba.payment_type,
tcba.out_id,
tcba.is_loss_settle,
tcba.confirm_flag as fin_confirm_flag,
tcba.finance_confirmed_date as fin_confirmed_date,
tcba.finance_confirmed_user as fin_confirmed_usr,
tcba.auto_withholding_confirmed_date as fin_auto_whd_confirmed_date,
tcba.auto_withholding_confirmed_user as fin_auto_whd_confirmed_usr,
tcba.finance_bank_id as fin_bank_id,
tcba.accountant_confirm_status as acct_confirm_status,
tcba.accountant_confirm_user as acct_confirm_usr,
tcba.accountant_confirm_date as acct_confirm_date,
tcba.tuandai_advance_status,
tcba.tuandai_profit_status,
tcba.tuandai_distribute_fund_status,
tcba.tuandai_distribute_fund_remark,
tcba.issue_after_type,
tcba.business_after_guid,
tcba.tracking_after_type,
tcba.borrow_date as shd_repay_date,
tcba.fatct_replayDate as act_replay_Date,
tcba.borrow_money,
tcba.oddcorpus,
tcba.current_accrual as shd_amt,
tcba.fact_accrual as act_amt,
tcba.operator_name as create_usr,
tcba.operator_name as modify_usr,
tcba.create_time as create_time,
tcba.modify_time as modify_time ,
'1' as Is_Valid,
'tuandai_bm'	as	dw_src_sys	,--	来源系统
'DWD_DATA.dwd_agr_xd_car_business_after,DWS_DATA.dws_agr_xd_business,DWD_DATA.dwd_agr_xd_issue_business_after_detail..'	as	dw_src_tbl	,--	来源表
now()	as	dw_ins_tm	,--	插入时间
now()	as	dw_upd_tm	,--	更新时间
'dailiang'	as	dw_ins_usr	,--	插入用户
'dailiang'	as	dw_upd_usr	,--	更新用户
DATE_FORMAT('${pt_day}','%Y-%m-%d')	as	part_dt	--	分区日期
from DWD_DATA.dwd_agr_xd_car_business_after tcba
left join DWS_DATA.dws_agr_xd_business xd
       on tcba.car_business_id = xd.business_id
	  and xd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
left join DWD_DATA.dwd_agr_xd_issue_business_after_detail  tibd	 
       on tcba.car_business_id = tibd.business_id
	  and tcba.car_business_after_id = tibd.business_after_id  
	  and tibd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
where tcba.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
  and IFNULL(xd.issue_type,0) = 1
  and tibd.business_id is null</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>Y</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>400</xloc>
      <yloc>320</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>线下表数据输入</name>
    <type>TableInput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>dwd_data</connection>
    <sql>select 
tcba.car_business_id AS business_id,
CASE WHEN xd.is_extension = 1 THEN tcba.car_business_after_defer ELSE tcba.car_business_id end ext_business_id,-- [业务编号，即原业务则是原业务编号，展期业务则是展期业务编号]
tcba.car_business_after_id AS cur_repay_period,
tcba.paratype as business_type,
xd.is_extension as is_defer,
tcba.car_business_after_defer as business_defer_id,
tcba.car_business_defer_id as cur_defer_id,
'0' as is_issue, -- 是否上标，1：是，:0：否
xd.customer_id,
xd.input_time,
'' as issue_id,
tcba.repayment_type as repay_type,
tcba.car_business_after_type as repay_status_type,
tcba.reserve_2 as repay_status_subtype,
tcba.repayed_flag as repayed_type,
tcbd.fee_id,
tcbd.fee_name,
tcbd.after_fee_type as fee_type,
tcba.overdueDays as ovd_days,
tcba.workflowstatus,
tcba.is_collection,
tcba.collectionDate as collection_Date,
tcba.collection_user as collection_usr,
tcba.payment_type,
tcba.out_id,
tcba.is_loss_settle,
tcba.confirm_flag as fin_confirm_flag,
tcba.finance_confirmed_date as fin_confirmed_date,
tcba.finance_confirmed_user as fin_confirmed_usr,
tcba.auto_withholding_confirmed_date as fin_auto_whd_confirmed_date,
tcba.auto_withholding_confirmed_user as fin_auto_whd_confirmed_usr,
tcba.finance_bank_id as fin_bank_id,
tcba.accountant_confirm_status as acct_confirm_status,
tcba.accountant_confirm_user as acct_confirm_usr,
tcba.accountant_confirm_date as acct_confirm_date,
tcba.tuandai_advance_status,
tcba.tuandai_profit_status,
tcba.tuandai_distribute_fund_status,
tcba.tuandai_distribute_fund_remark,
tcba.issue_after_type,
tcba.business_after_guid,
tcba.tracking_after_type,
tcbd.plan_repayment_date as shd_repay_date,
tcbd.actual_repayment_date as act_replay_Date,
tcba.borrow_money,
tcba.oddcorpus,
tcbd.plan_fee_value as shd_amt,
tcbd.actual_fee_value as act_amt,
tcbd.create_user as create_usr,
tcbd.update_user as modify_usr,
tcbd.create_time as create_time,
tcbd.update_time as modify_time ,
'1' as Is_Valid,
'tuandai_bm'	as	dw_src_sys	,--	来源系统
'DWD_DATA.dwd_agr_xd_car_business_after,DWS_DATA.dws_agr_xd_business,DWD_DATA.dwd_agr_xd_car_business_after_detail..'	as	dw_src_tbl	,--	来源表
now()	as	dw_ins_tm	,--	插入时间
now()	as	dw_upd_tm	,--	更新时间
'dailiang'	as	dw_ins_usr	,--	插入用户
'dailiang'	as	dw_upd_usr	,--	更新用户
DATE_FORMAT('${pt_day}','%Y-%m-%d')	as	part_dt	--	分区日期
from DWD_DATA.dwd_agr_xd_car_business_after tcba
left join DWS_DATA.dws_agr_xd_business xd
       on tcba.car_business_id = xd.business_id
	  and xd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
left join DWD_DATA.dwd_agr_xd_car_business_after_detail  tcbd	 
       on tcba.car_business_id = tcbd.business_id
	  and tcba.car_business_after_id = tcbd.business_after_id  
	  and tcbd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
where tcba.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
  and IFNULL(xd.issue_type,0) &lt;&gt; 1
  and tcbd.business_id is not null
  
 union all
 -- （tb_car_business_after_detail于2017年5月上线，tb_car_business_after5月之前的数据没有导入tb_car_business_after_detail，这里手动导入本金和利息）
 -- 本金
select 
tcba.car_business_id AS business_id,
CASE WHEN xd.is_extension = 1 THEN tcba.car_business_after_defer ELSE tcba.car_business_id end ext_business_id,-- [业务编号，即原业务则是原业务编号，展期业务则是展期业务编号]
tcba.car_business_after_id AS cur_repay_period,
tcba.paratype as business_type,
xd.is_extension as is_defer,
tcba.car_business_after_defer as business_defer_id,
tcba.car_business_defer_id as cur_defer_id,
'0' as is_issue, -- 是否上标，1：是，:0：否
xd.customer_id,
xd.input_time,
'' as issue_id,
tcba.repayment_type as repay_type,
tcba.car_business_after_type as repay_status_type,
tcba.reserve_2 as repay_status_subtype,
tcba.repayed_flag as repayed_type,
'b69a84dc-ed67-4c9f-80bf-89ee8efd5167' as fee_id,
'本金' as fee_name,
1 as fee_type,
tcba.overdueDays as ovd_days,
tcba.workflowstatus,
tcba.is_collection,
tcba.collectionDate as collection_Date,
tcba.collection_user as collection_usr,
tcba.payment_type,
tcba.out_id,
tcba.is_loss_settle,
tcba.confirm_flag as fin_confirm_flag,
tcba.finance_confirmed_date as fin_confirmed_date,
tcba.finance_confirmed_user as fin_confirmed_usr,
tcba.auto_withholding_confirmed_date as fin_auto_whd_confirmed_date,
tcba.auto_withholding_confirmed_user as fin_auto_whd_confirmed_usr,
tcba.finance_bank_id as fin_bank_id,
tcba.accountant_confirm_status as acct_confirm_status,
tcba.accountant_confirm_user as acct_confirm_usr,
tcba.accountant_confirm_date as acct_confirm_date,
tcba.tuandai_advance_status,
tcba.tuandai_profit_status,
tcba.tuandai_distribute_fund_status,
tcba.tuandai_distribute_fund_remark,
tcba.issue_after_type,
tcba.business_after_guid,
tcba.tracking_after_type,
tcba.borrow_date as shd_repay_date,
tcba.fatct_replayDate as act_replay_Date,
tcba.borrow_money,
tcba.oddcorpus,
tcba.current_Principa as shd_amt,
tcba.fact_principa as act_amt,
tcba.operator_name as create_usr,
tcba.operator_name as modify_usr,
tcba.create_time as create_time,
tcba.modify_time as modify_time ,
'1' as Is_Valid,
'tuandai_bm'	as	dw_src_sys	,--	来源系统
'DWD_DATA.dwd_agr_xd_car_business_after,DWS_DATA.dws_agr_xd_business,DWD_DATA.dwd_agr_xd_car_business_after_detail..'	as	dw_src_tbl	,--	来源表
now()	as	dw_ins_tm	,--	插入时间
now()	as	dw_upd_tm	,--	更新时间
'dailiang'	as	dw_ins_usr	,--	插入用户
'dailiang'	as	dw_upd_usr	,--	更新用户
DATE_FORMAT('${pt_day}','%Y-%m-%d')	as	part_dt	--	分区日期
from DWD_DATA.dwd_agr_xd_car_business_after tcba
left join DWS_DATA.dws_agr_xd_business xd
       on tcba.car_business_id = xd.business_id
	  and xd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
left join DWD_DATA.dwd_agr_xd_car_business_after_detail  tcbd	 
       on tcba.car_business_id = tcbd.business_id
	  and tcba.car_business_after_id = tcbd.business_after_id  
	  and tcbd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
where tcba.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
  and IFNULL(xd.issue_type,0) &lt;&gt; 1
  and tcbd.business_id is null
 
 union all
  -- 利息
select 
tcba.car_business_id AS business_id,
CASE WHEN xd.is_extension = 1 THEN tcba.car_business_after_defer ELSE tcba.car_business_id end ext_business_id,-- [业务编号，即原业务则是原业务编号，展期业务则是展期业务编号]
tcba.car_business_after_id AS cur_repay_period,
tcba.paratype as business_type,
xd.is_extension as is_defer,
tcba.car_business_after_defer as business_defer_id,
tcba.car_business_defer_id as cur_defer_id,
'0' as is_issue, -- 是否上标，1：是，:0：否
xd.customer_id,
xd.input_time,
'' as issue_id,
tcba.repayment_type as repay_type,
tcba.car_business_after_type as repay_status_type,
tcba.reserve_2 as repay_status_subtype,
tcba.repayed_flag as repayed_type,
'556bce4f-f3a9-4b7a-a8b1-43368bebb49c' as fee_id,
'利息' as fee_name,
2 as fee_type,
tcba.overdueDays as ovd_days,
tcba.workflowstatus,
tcba.is_collection,
tcba.collectionDate as collection_Date,
tcba.collection_user as collection_usr,
tcba.payment_type,
tcba.out_id,
tcba.is_loss_settle,
tcba.confirm_flag as fin_confirm_flag,
tcba.finance_confirmed_date as fin_confirmed_date,
tcba.finance_confirmed_user as fin_confirmed_usr,
tcba.auto_withholding_confirmed_date as fin_auto_whd_confirmed_date,
tcba.auto_withholding_confirmed_user as fin_auto_whd_confirmed_usr,
tcba.finance_bank_id as fin_bank_id,
tcba.accountant_confirm_status as acct_confirm_status,
tcba.accountant_confirm_user as acct_confirm_usr,
tcba.accountant_confirm_date as acct_confirm_date,
tcba.tuandai_advance_status,
tcba.tuandai_profit_status,
tcba.tuandai_distribute_fund_status,
tcba.tuandai_distribute_fund_remark,
tcba.issue_after_type,
tcba.business_after_guid,
tcba.tracking_after_type,
tcba.borrow_date as shd_repay_date,
tcba.fatct_replayDate as act_replay_Date,
tcba.borrow_money,
tcba.oddcorpus,
tcba.current_accrual as shd_amt,
tcba.fact_accrual as act_amt,
tcba.operator_name as create_usr,
tcba.operator_name as modify_usr,
tcba.create_time as create_time,
tcba.modify_time as modify_time ,
'1' as Is_Valid,
'tuandai_bm'	as	dw_src_sys	,--	来源系统
'DWD_DATA.dwd_agr_xd_car_business_after,DWS_DATA.dws_agr_xd_business,DWD_DATA.dwd_agr_xd_car_business_after_detail..'	as	dw_src_tbl	,--	来源表
now()	as	dw_ins_tm	,--	插入时间
now()	as	dw_upd_tm	,--	更新时间
'dailiang'	as	dw_ins_usr	,--	插入用户
'dailiang'	as	dw_upd_usr	,--	更新用户
DATE_FORMAT('${pt_day}','%Y-%m-%d')	as	part_dt	--	分区日期
from DWD_DATA.dwd_agr_xd_car_business_after tcba
left join DWS_DATA.dws_agr_xd_business xd
       on tcba.car_business_id = xd.business_id
	  and xd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
left join DWD_DATA.dwd_agr_xd_car_business_after_detail  tcbd	 
       on tcba.car_business_id = tcbd.business_id
	  and tcba.car_business_after_id = tcbd.business_after_id  
	  and tcbd.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
where tcba.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
  and IFNULL(xd.issue_type,0) &lt;&gt; 1
  and tcbd.business_id is null
</sql>
    <limit>0</limit>
    <lookup/>
    <execute_each_row>N</execute_each_row>
    <variables_active>Y</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>400</xloc>
      <yloc>160</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>表输出</name>
    <type>TableOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>DWS_DATA</connection>
    <schema/>
    <table>dws_agr_xd_business_after</table>
    <commit>1000</commit>
    <truncate>N</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>Y</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field/>
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field/>
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field/>
    <fields>
      <field>
        <column_name>business_id</column_name>
        <stream_name>business_id</stream_name>
      </field>
      <field>
        <column_name>ext_business_id</column_name>
        <stream_name>ext_business_id</stream_name>
      </field>
      <field>
        <column_name>cur_repay_period</column_name>
        <stream_name>cur_repay_period</stream_name>
      </field>
      <field>
        <column_name>business_type</column_name>
        <stream_name>business_type</stream_name>
      </field>
      <field>
        <column_name>is_defer</column_name>
        <stream_name>is_defer</stream_name>
      </field>
      <field>
        <column_name>business_defer_id</column_name>
        <stream_name>business_defer_id</stream_name>
      </field>
      <field>
        <column_name>cur_defer_id</column_name>
        <stream_name>cur_defer_id</stream_name>
      </field>
      <field>
        <column_name>is_issue</column_name>
        <stream_name>is_issue</stream_name>
      </field>
      <field>
        <column_name>customer_id</column_name>
        <stream_name>customer_id</stream_name>
      </field>
      <field>
        <column_name>input_time</column_name>
        <stream_name>input_time</stream_name>
      </field>
      <field>
        <column_name>issue_id</column_name>
        <stream_name>issue_id</stream_name>
      </field>
      <field>
        <column_name>repay_type</column_name>
        <stream_name>repay_type</stream_name>
      </field>
      <field>
        <column_name>repay_status_type</column_name>
        <stream_name>repay_status_type</stream_name>
      </field>
      <field>
        <column_name>repay_status_subtype</column_name>
        <stream_name>repay_status_subtype</stream_name>
      </field>
      <field>
        <column_name>repayed_type</column_name>
        <stream_name>repayed_type</stream_name>
      </field>
      <field>
        <column_name>fee_id</column_name>
        <stream_name>fee_id</stream_name>
      </field>
      <field>
        <column_name>fee_name</column_name>
        <stream_name>fee_name</stream_name>
      </field>
      <field>
        <column_name>fee_type</column_name>
        <stream_name>fee_type</stream_name>
      </field>
      <field>
        <column_name>ovd_days</column_name>
        <stream_name>ovd_days</stream_name>
      </field>
      <field>
        <column_name>workflowstatus</column_name>
        <stream_name>workflowstatus</stream_name>
      </field>
      <field>
        <column_name>is_collection</column_name>
        <stream_name>is_collection</stream_name>
      </field>
      <field>
        <column_name>collection_Date</column_name>
        <stream_name>collection_Date</stream_name>
      </field>
      <field>
        <column_name>collection_usr</column_name>
        <stream_name>collection_usr</stream_name>
      </field>
      <field>
        <column_name>payment_type</column_name>
        <stream_name>payment_type</stream_name>
      </field>
      <field>
        <column_name>out_id</column_name>
        <stream_name>out_id</stream_name>
      </field>
      <field>
        <column_name>is_loss_settle</column_name>
        <stream_name>is_loss_settle</stream_name>
      </field>
      <field>
        <column_name>fin_confirm_flag</column_name>
        <stream_name>fin_confirm_flag</stream_name>
      </field>
      <field>
        <column_name>fin_confirmed_date</column_name>
        <stream_name>fin_confirmed_date</stream_name>
      </field>
      <field>
        <column_name>fin_confirmed_usr</column_name>
        <stream_name>fin_confirmed_usr</stream_name>
      </field>
      <field>
        <column_name>fin_auto_whd_confirmed_date</column_name>
        <stream_name>fin_auto_whd_confirmed_date</stream_name>
      </field>
      <field>
        <column_name>fin_auto_whd_confirmed_usr</column_name>
        <stream_name>fin_auto_whd_confirmed_usr</stream_name>
      </field>
      <field>
        <column_name>fin_bank_id</column_name>
        <stream_name>fin_bank_id</stream_name>
      </field>
      <field>
        <column_name>acct_confirm_status</column_name>
        <stream_name>acct_confirm_status</stream_name>
      </field>
      <field>
        <column_name>acct_confirm_usr</column_name>
        <stream_name>acct_confirm_usr</stream_name>
      </field>
      <field>
        <column_name>acct_confirm_date</column_name>
        <stream_name>acct_confirm_date</stream_name>
      </field>
      <field>
        <column_name>tuandai_advance_status</column_name>
        <stream_name>tuandai_advance_status</stream_name>
      </field>
      <field>
        <column_name>tuandai_profit_status</column_name>
        <stream_name>tuandai_profit_status</stream_name>
      </field>
      <field>
        <column_name>tuandai_distribute_fund_status</column_name>
        <stream_name>tuandai_distribute_fund_status</stream_name>
      </field>
      <field>
        <column_name>tuandai_distribute_fund_remark</column_name>
        <stream_name>tuandai_distribute_fund_remark</stream_name>
      </field>
      <field>
        <column_name>issue_after_type</column_name>
        <stream_name>issue_after_type</stream_name>
      </field>
      <field>
        <column_name>business_after_guid</column_name>
        <stream_name>business_after_guid</stream_name>
      </field>
      <field>
        <column_name>tracking_after_type</column_name>
        <stream_name>tracking_after_type</stream_name>
      </field>
      <field>
        <column_name>shd_repay_date</column_name>
        <stream_name>shd_repay_date</stream_name>
      </field>
      <field>
        <column_name>act_replay_Date</column_name>
        <stream_name>act_replay_Date</stream_name>
      </field>
      <field>
        <column_name>borrow_money</column_name>
        <stream_name>borrow_money</stream_name>
      </field>
      <field>
        <column_name>oddcorpus</column_name>
        <stream_name>oddcorpus</stream_name>
      </field>
      <field>
        <column_name>shd_amt</column_name>
        <stream_name>shd_amt</stream_name>
      </field>
      <field>
        <column_name>act_amt</column_name>
        <stream_name>act_amt</stream_name>
      </field>
      <field>
        <column_name>create_usr</column_name>
        <stream_name>create_usr</stream_name>
      </field>
      <field>
        <column_name>modify_usr</column_name>
        <stream_name>modify_usr</stream_name>
      </field>
      <field>
        <column_name>create_time</column_name>
        <stream_name>create_time</stream_name>
      </field>
      <field>
        <column_name>modify_time</column_name>
        <stream_name>modify_time</stream_name>
      </field>
      <field>
        <column_name>Is_Valid</column_name>
        <stream_name>Is_Valid</stream_name>
      </field>
      <field>
        <column_name>dw_src_sys</column_name>
        <stream_name>dw_src_sys</stream_name>
      </field>
      <field>
        <column_name>dw_src_tbl</column_name>
        <stream_name>dw_src_tbl</stream_name>
      </field>
      <field>
        <column_name>dw_ins_tm</column_name>
        <stream_name>dw_ins_tm</stream_name>
      </field>
      <field>
        <column_name>dw_upd_tm</column_name>
        <stream_name>dw_upd_tm</stream_name>
      </field>
      <field>
        <column_name>dw_ins_usr</column_name>
        <stream_name>dw_ins_usr</stream_name>
      </field>
      <field>
        <column_name>dw_upd_usr</column_name>
        <stream_name>dw_upd_usr</stream_name>
      </field>
      <field>
        <column_name>part_dt</column_name>
        <stream_name>part_dt</stream_name>
      </field>
    </fields>
    <cluster_schema/>
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>720</xloc>
      <yloc>224</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
</transformation>
