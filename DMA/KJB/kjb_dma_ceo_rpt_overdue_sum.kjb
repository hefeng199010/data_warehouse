<?xml version="1.0" encoding="UTF-8"?>
<job>
  <name>kjb_dma_ceo_rpt_overdue_sum</name>
  <description/>
  <extended_description>ceo看板逾期汇总表</extended_description>
  <job_version/>
  <job_status>0</job_status>
  <directory>/</directory>
  <created_user>-</created_user>
  <created_date>2018/01/26 14:01:05.270</created_date>
  <modified_user>-</modified_user>
  <modified_date>2018/01/31 11:51:34.108</modified_date>
  <parameters>
    <parameter>
      <name>${p_day}</name>
      <default_value>20180328</default_value>
      <description/>
    </parameter>
    <parameter>
      <name>${p_duty_nm}</name>
      <default_value>dma_ceo_rpt_overdue_sum</default_value>
      <description/>
    </parameter>
  </parameters>
  <connection>
    <name>DMA_SAL_ACHV_DATA</name>
    <server>${UAT_DC_DB_HOST}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${UAT_DC_DB_DMA_SAL_ACHVNAME}</database>
    <port>3306</port>
    <username>${UAT_DC_DB_USER}</username>
    <password>${UAT_DC_DB_PWD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.characterEncoding</code>
        <attribute>utf8</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>public_data</name>
    <server>${UAT_DC_DB_HOST}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${UAT_DC_DB_PUBLIC_NAME}</database>
    <port>3306</port>
    <username>${UAT_DC_DB_USER}</username>
    <password>${UAT_DC_DB_PWD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.characterEncoding</code>
        <attribute>utf8</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <slaveservers>
    </slaveservers>
  <job-log-table>
    <connection/>
    <schema/>
    <table/>
    <size_limit_lines/>
    <interval/>
    <timeout_days/>
    <field>
      <id>ID_JOB</id>
      <enabled>Y</enabled>
      <name>ID_JOB</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>JOBNAME</name>
    </field>
    <field>
      <id>STATUS</id>
      <enabled>Y</enabled>
      <name>STATUS</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>STARTDATE</id>
      <enabled>Y</enabled>
      <name>STARTDATE</name>
    </field>
    <field>
      <id>ENDDATE</id>
      <enabled>Y</enabled>
      <name>ENDDATE</name>
    </field>
    <field>
      <id>LOGDATE</id>
      <enabled>Y</enabled>
      <name>LOGDATE</name>
    </field>
    <field>
      <id>DEPDATE</id>
      <enabled>Y</enabled>
      <name>DEPDATE</name>
    </field>
    <field>
      <id>REPLAYDATE</id>
      <enabled>Y</enabled>
      <name>REPLAYDATE</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>Y</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>EXECUTING_SERVER</id>
      <enabled>N</enabled>
      <name>EXECUTING_SERVER</name>
    </field>
    <field>
      <id>EXECUTING_USER</id>
      <enabled>N</enabled>
      <name>EXECUTING_USER</name>
    </field>
    <field>
      <id>START_JOB_ENTRY</id>
      <enabled>N</enabled>
      <name>START_JOB_ENTRY</name>
    </field>
    <field>
      <id>CLIENT</id>
      <enabled>N</enabled>
      <name>CLIENT</name>
    </field>
  </job-log-table>
  <jobentry-log-table>
    <connection/>
    <schema/>
    <table/>
    <timeout_days/>
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>TRANSNAME</name>
    </field>
    <field>
      <id>JOBENTRYNAME</id>
      <enabled>Y</enabled>
      <name>STEPNAME</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>RESULT</id>
      <enabled>Y</enabled>
      <name>RESULT</name>
    </field>
    <field>
      <id>NR_RESULT_ROWS</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_ROWS</name>
    </field>
    <field>
      <id>NR_RESULT_FILES</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_FILES</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>N</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>COPY_NR</id>
      <enabled>N</enabled>
      <name>COPY_NR</name>
    </field>
  </jobentry-log-table>
  <channel-log-table>
    <connection/>
    <schema/>
    <table/>
    <timeout_days/>
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>LOGGING_OBJECT_TYPE</id>
      <enabled>Y</enabled>
      <name>LOGGING_OBJECT_TYPE</name>
    </field>
    <field>
      <id>OBJECT_NAME</id>
      <enabled>Y</enabled>
      <name>OBJECT_NAME</name>
    </field>
    <field>
      <id>OBJECT_COPY</id>
      <enabled>Y</enabled>
      <name>OBJECT_COPY</name>
    </field>
    <field>
      <id>REPOSITORY_DIRECTORY</id>
      <enabled>Y</enabled>
      <name>REPOSITORY_DIRECTORY</name>
    </field>
    <field>
      <id>FILENAME</id>
      <enabled>Y</enabled>
      <name>FILENAME</name>
    </field>
    <field>
      <id>OBJECT_ID</id>
      <enabled>Y</enabled>
      <name>OBJECT_ID</name>
    </field>
    <field>
      <id>OBJECT_REVISION</id>
      <enabled>Y</enabled>
      <name>OBJECT_REVISION</name>
    </field>
    <field>
      <id>PARENT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>PARENT_CHANNEL_ID</name>
    </field>
    <field>
      <id>ROOT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>ROOT_CHANNEL_ID</name>
    </field>
  </channel-log-table>
  <pass_batchid>N</pass_batchid>
  <shared_objects_file/>
  <entries>
    <entry>
      <name>START</name>
      <description/>
      <type>SPECIAL</type>
      <start>Y</start>
      <dummy>N</dummy>
      <repeat>N</repeat>
      <schedulerType>0</schedulerType>
      <intervalSeconds>0</intervalSeconds>
      <intervalMinutes>60</intervalMinutes>
      <hour>12</hour>
      <minutes>0</minutes>
      <weekDay>1</weekDay>
      <DayOfMonth>1</DayOfMonth>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>64</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>DUMMY</name>
      <description/>
      <type>SPECIAL</type>
      <start>N</start>
      <dummy>Y</dummy>
      <repeat>N</repeat>
      <schedulerType>0</schedulerType>
      <intervalSeconds>0</intervalSeconds>
      <intervalMinutes>60</intervalMinutes>
      <hour>12</hour>
      <minutes>0</minutes>
      <weekDay>1</weekDay>
      <DayOfMonth>1</DayOfMonth>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1264</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 100</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('11',
   '${p_duty_nm}',
	'1',
   '>>>>>>>>>> JOB START >>>>>>>>>>',
   '100',
   '任务开始！！',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>128</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>JavaScript_Return</name>
      <description/>
      <type>EVAL</type>
      <script>1 > 2 </script>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>688</xloc>
      <yloc>720</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 300</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'delete_data',
   '100',
   '删除数据！！',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>688</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 400</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   '>>>>>>>>>> JOB END >>>>>>>>>>',
   '100',
   '插入数据库',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1168</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 210</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'delete_data',
   '100',
   '删除数据异常',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>608</xloc>
      <yloc>592</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 310</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'ods_insert',
   '100',
   '插入数据异常',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>768</xloc>
      <yloc>608</yloc>
    </entry>
    <entry>
      <name>ktr_set_date</name>
      <description/>
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id/>
      <filename>${UAT_KTR_DIR}/PUBLIC/KTR/ktr_set_date.ktr</filename>
      <transname/>
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile/>
      <logext/>
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name/>
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>304</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 200</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'ktr_set_date',
   '200',
   '定义日期变量！！',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>352</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>Set variables</name>
      <description/>
      <type>SET_VARIABLES</type>
      <replacevars>Y</replacevars>
      <filename/>
      <file_variable_type>JVM</file_variable_type>
      <fields>
        <field>
          <variable_name>i_while_count</variable_name>
          <variable_value>0</variable_value>
          <variable_type>CURRENT_JOB</variable_type>
        </field>
      </fields>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>192</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>ktr_duty_check</name>
      <description/>
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id/>
      <filename>${UAT_KTR_DIR}/PUBLIC/KTR/ktr_duty_check.ktr</filename>
      <transname/>
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile/>
      <logext/>
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name/>
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>416</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>check_value</name>
      <description/>
      <type>SIMPLE_EVAL</type>
      <valuetype>variable</valuetype>
      <fieldname>pt_returnvalue</fieldname>
      <variablename>pt_returnvalue</variablename>
      <fieldtype>number</fieldtype>
      <mask/>
      <comparevalue>0</comparevalue>
      <minvalue/>
      <maxvalue/>
      <successcondition>equal</successcondition>
      <successnumbercondition>equal</successnumbercondition>
      <successbooleancondition>false</successbooleancondition>
      <successwhenvarset>N</successwhenvarset>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>512</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 210 2 2</name>
      <description/>
      <type>SQL</type>
      <sql>
insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'check_value',
   '100',
   CONCAT('${pt_returnvalue}','源表没有生成,需等待2分钟'),
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>512</xloc>
      <yloc>592</yloc>
    </entry>
    <entry>
      <name>Java_cycle</name>
      <description/>
      <type>EVAL</type>
      <script>var attempt = parent_job.getVariable("i_while_count");

if(attempt &lt; 10 )
{
   attempt++;
   parent_job.setVariable("i_while_count", attempt); 

   true;

}
else
{
   

   false;
}
</script>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>448</xloc>
      <yloc>720</yloc>
    </entry>
    <entry>
      <name>Wait for</name>
      <description/>
      <type>DELAY</type>
      <maximumTimeout>2</maximumTimeout>
      <scaletime>1</scaletime>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>416</xloc>
      <yloc>592</yloc>
    </entry>
    <entry>
      <name>ktr_duty_insert</name>
      <description/>
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id/>
      <filename>${UAT_KTR_DIR}/PUBLIC/KTR/ktr_duty_insert.ktr</filename>
      <transname/>
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile/>
      <logext/>
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name/>
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1088</xloc>
      <yloc>496</yloc>
    </entry>
    <entry>
      <name>delete_data 2</name>
      <description/>
      <type>SQL</type>
      <sql>alter table DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_sum truncate partition dma_ceo_rpt_overdue_sum_${pt_day};
</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>DMA_SAL_ACHV_DATA</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>608</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 120</name>
      <description/>
      <type>SQL</type>
      <sql>
insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'ktr_duty_check',
   '100',
   CONCAT('${pt_returnvalue}','  源表或依赖任务异常'),
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>576</xloc>
      <yloc>720</yloc>
    </entry>
    <entry>
      <name>insert_data</name>
      <description/>
      <type>SQL</type>
      <sql>SET SESSION tmp_table_size=1024*1024*1024;
SET SESSION max_heap_table_size=1024*1024*1024;
SET SESSION group_concat_max_len=102400;


INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
    ('${pt_dutyno}', '${p_duty_nm}','1','>>>>>>>>>> JOB START >>>>>>>>>>', '0', '总共2步！！', 0,'${p_day}',  NOW(),  'caihl' );


/*逾期单数 最细粒度到单号*/
DROP TEMPORARY TABLE IF EXISTS dma_ceo_rpt_overdue_sum_tmp ;
CREATE TEMPORARY TABLE `dma_ceo_rpt_overdue_sum_tmp` (
  `business_id` VARCHAR(50) DEFAULT NULL COMMENT '业务编号',
  `area_nm` VARCHAR(100) DEFAULT NULL COMMENT '片区',
  `branch_nm` VARCHAR(100) DEFAULT NULL COMMENT '分公司',
  `business_type_nm` VARCHAR(50) DEFAULT NULL COMMENT '业务类型',
  `borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `actual_principal` DECIMAL(15,2) DEFAULT NULL,
  `left_principa_amt` DECIMAL(35,2) DEFAULT NULL,
  `no_settle_cnt` INT(5) NOT NULL DEFAULT '0',
  `overdue_cnt` INT(5) DEFAULT NULL,
  `ovd_borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `ovd_left_prin_amt` DECIMAL(12,2) DEFAULT NULL,
   `m0_cnt` INT(5) DEFAULT NULL,
  `m1_cnt` INT(5) DEFAULT NULL,
  `m2_cnt` INT(5) DEFAULT NULL,
  `m3_cnt` INT(5) DEFAULT NULL,
  `m3_plus_cnt` INT(5) DEFAULT NULL,
  `m0_borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `m0_left_prin_amt` DECIMAL(12,2) DEFAULT NULL,
  `m1_borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `m1_left_prin_amt` DECIMAL(12,2) DEFAULT NULL,
  `m2_borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `m2_left_prin_amt` DECIMAL(12,2) DEFAULT NULL,
  `m3_borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `m3_left_prin_amt` DECIMAL(12,2) DEFAULT NULL,
  `m3_plus_borrow_amt` DECIMAL(12,2) DEFAULT NULL,
  `m3_plus_left_prin_amt` DECIMAL(12,2) DEFAULT NULL,
  `m0_ode_prpa_amt` DECIMAL(15,2) DEFAULT NULL, 
  `m0_ode_acal_amt` DECIMAL(15,2) DEFAULT NULL, 
  `m0_ode_breach_amt` DECIMAL(15,2) DEFAULT NULL,
  `m0_ode_other_amt` DECIMAL(15,2) DEFAULT NULL,
  `m1_ode_prpa_amt` DECIMAL(15,2) DEFAULT NULL,
  `m1_ode_acal_amt` DECIMAL(15,2) DEFAULT NULL,
  `m1_ode_breach_amt` DECIMAL(15,2) DEFAULT NULL,
  `m1_ode_other_amt` DECIMAL(15,2) DEFAULT NULL,
  `m2_ode_prpa_amt` DECIMAL(15,2) DEFAULT NULL,
  `m2_ode_acal_amt` DECIMAL(15,2) DEFAULT NULL,
  `m2_ode_breach_amt` DECIMAL(15,2) DEFAULT NULL,
  `m2_ode_other_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_ode_prpa_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_ode_acal_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_ode_breach_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_ode_other_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_plus_ode_prpa_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_plus_ode_acal_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_plus_ode_breach_amt` DECIMAL(15,2) DEFAULT NULL,
  `m3_plus_ode_other_amt` DECIMAL(15,2) DEFAULT NULL,
  INDEX idx_business_id(business_id)
) ENGINE=INNODB DEFAULT CHARSET=utf8
;

INSERT INTO dma_ceo_rpt_overdue_sum_tmp 
SELECT t.business_id
,t.area_nm                                 -- 片区           
,t.branch_nm                               -- 分公司   
,t.business_type_nm                     # 业务类型  
,MAX(IFNULL(borrow_amt,0))                  AS borrow_amt -- 借款金额
,SUM(t.actual_principal) AS actual_principal
,MAX(t.borrow_amt) - SUM(t.actual_principal) AS left_principa_amt  -- 业务单的剩余本金算法
,1 AS no_settle_cnt -- 未结清
,MAX(CASE WHEN t.max_ovd_days>0 THEN 1 ELSE 0 END)  AS overdue_cnt -- 逾期
,MAX(CASE WHEN t.max_ovd_days>0 THEN t.borrow_amt  ELSE 0 END          ) AS ovd_borrow_amt                       -- 总逾期借款金额 
,MAX(CASE WHEN t.max_ovd_days>0 THEN t.left_principa_amt  ELSE 0 END   ) AS ovd_left_prin_amt                    -- 总逾期剩余本金 
,MAX(CASE WHEN t.max_ovd_days &lt; 1              THEN 1 ELSE 0 END  ) AS m0_cnt             -- M0单数
,MAX(CASE WHEN t.max_ovd_days BETWEEN 1 AND 30 THEN 1 ELSE 0 END  ) AS m1_cnt             -- M1单数
,MAX(CASE WHEN t.max_ovd_days BETWEEN 31 AND 60 THEN 1 ELSE 0 END ) AS m2_cnt             -- M2单数
,MAX(CASE WHEN t.max_ovd_days BETWEEN 61 AND 90 THEN 1 ELSE 0 END ) AS m3_cnt             -- M1单数
,MAX(CASE WHEN t.max_ovd_days > 90 THEN 1 ELSE 0 END              ) AS m3_plus_cnt         -- M1单数
,MAX(CASE WHEN t.max_ovd_days &lt; 1              THEN t.`borrow_amt` ELSE 0 END )         AS m0_borrow_amt                        -- M1借款金额 
,MAX(CASE WHEN t.max_ovd_days &lt; 1              THEN t.`left_principa_amt` ELSE 0 END )  AS m0_left_prin_amt                     -- M1剩余本金    
,MAX(CASE WHEN t.max_ovd_days BETWEEN 1 AND 30 THEN t.`borrow_amt` ELSE 0 END )         AS m1_borrow_amt                        -- M1借款金额     
,MAX(CASE WHEN t.max_ovd_days BETWEEN 1 AND 30 THEN t.`left_principa_amt` ELSE 0 END )  AS m1_left_prin_amt                     -- M1剩余本金     
,MAX(CASE WHEN t.max_ovd_days BETWEEN 31 AND 60 THEN t.`borrow_amt` ELSE 0 END )        AS m2_borrow_amt                        -- M1借款金额     
,MAX(CASE WHEN t.max_ovd_days BETWEEN 31 AND 60 THEN t.`left_principa_amt` ELSE 0 END ) AS m2_left_prin_amt                     -- M1剩余本金    
,MAX(CASE WHEN t.max_ovd_days BETWEEN 61 AND 90 THEN t.`borrow_amt` ELSE 0 END )        AS m3_borrow_amt                        -- M1借款金额     
,MAX(CASE WHEN t.max_ovd_days BETWEEN 61 AND 90 THEN t.`left_principa_amt` ELSE 0 END ) AS m3_left_prin_amt                     -- M1剩余本金 
,MAX(CASE WHEN t.max_ovd_days > 90 THEN t.`borrow_amt` ELSE 0 END )                     AS m3_plus_borrow_amt                   -- M1借款金额     
,MAX(CASE WHEN t.max_ovd_days > 90 THEN t.`left_principa_amt` ELSE 0 END )              AS m3_plus_left_prin_amt                -- M1剩余本金 
,SUM(CASE WHEN (t.max_ovd_days &lt; 1 )  THEN t.receive_principal ELSE 0 END)                                  AS m0_ode_prpa_amt
,SUM(CASE WHEN (t.max_ovd_days &lt; 1 )  THEN t.receive_interest ELSE 0 END)                                   AS m0_ode_acal_amt
,SUM(CASE WHEN (t.max_ovd_days &lt; 1 )  THEN t.receive_platform_delaying_payment                 ELSE 0 END)  AS m0_ode_breach_amt -- 应还滞纳金怎么取？
,SUM(CASE WHEN (t.max_ovd_days &lt; 1 )  THEN t.receive_other_fee ELSE 0 END)                                  AS m0_ode_other_amt 
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 1 AND 30 ) AND (t.cur_ovd_days >0) THEN t.receive_principal ELSE 0 END) AS m1_ode_prpa_amt
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 1 AND 30 ) AND (t.cur_ovd_days >0) THEN t.receive_interest ELSE 0 END)  AS m1_ode_acal_amt
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 1 AND 30 ) AND (t.cur_ovd_days >0) THEN t.receive_platform_delaying_payment                 ELSE 0 END)  AS m1_ode_breach_amt -- 应还滞纳金怎么取？
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 1 AND 30 ) AND (t.cur_ovd_days >0) THEN t.receive_other_fee ELSE 0 END) AS m1_ode_other_amt 
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 31 AND 60 ) AND (t.cur_ovd_days >0) THEN t.receive_principal ELSE 0 END) AS m2_ode_prpa_amt
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 31 AND 60 ) AND (t.cur_ovd_days >0) THEN t.receive_interest ELSE 0 END)  AS m2_ode_acal_amt
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 31 AND 60 ) AND (t.cur_ovd_days >0) THEN t.receive_platform_delaying_payment                  ELSE 0 END)  AS m2_ode_breach_amt -- 应还滞纳金怎么取？
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 31 AND 60 ) AND (t.cur_ovd_days >0) THEN t.receive_other_fee ELSE 0 END) AS m2_ode_other_amt 
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 61 AND 90 ) AND (t.cur_ovd_days >0) THEN t.receive_principal ELSE 0 END) AS m3_ode_prpa_amt
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 61 AND 90 ) AND (t.cur_ovd_days >0) THEN t.receive_interest ELSE 0 END)  AS m3_ode_acal_amt
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 61 AND 90 ) AND (t.cur_ovd_days >0) THEN t.receive_platform_delaying_payment                 ELSE 0 END)  AS m3_ode_breach_amt -- 应还滞纳金怎么取？
,SUM(CASE WHEN (t.max_ovd_days BETWEEN 61 AND 90 ) AND (t.cur_ovd_days >0) THEN t.receive_other_fee ELSE 0 END) AS m3_ode_other_amt 
,SUM(CASE WHEN (t.max_ovd_days > 90 ) AND (t.cur_ovd_days >0) THEN t.receive_principal ELSE 0 END) AS m3_plus_ode_prpa_amt
,SUM(CASE WHEN (t.max_ovd_days > 90 ) AND (t.cur_ovd_days >0) THEN t.receive_interest ELSE 0 END)  AS m3_plus_ode_acal_amt
,SUM(CASE WHEN (t.max_ovd_days > 90 ) AND (t.cur_ovd_days >0) THEN t.receive_platform_delaying_payment                  ELSE 0 END)  AS m3_plus_ode_breach_amt -- 应还滞纳金怎么取？
,SUM(CASE WHEN (t.max_ovd_days > 90 ) AND (t.cur_ovd_days >0) THEN t.receive_other_fee ELSE 0 END) AS m3_plus_ode_other_amt 
FROM DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail t   -- 由于tb_business_ods 中获取不到业务单号的还款状态 所以使用dws表
WHERE t.part_dt =DATE'${pt_day}'
GROUP BY
t.business_id
,t.area_nm                                 -- 片区           
,t.branch_nm                               -- 分公司
,t.business_type_nm  
;


 INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第1步骤 获取业务单最细粒度数据', '100', 'dma_ceo_rpt_overdue_sum_tmp', 0,'${pt_day}',  NOW(),  'caihl' );  


INSERT INTO DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_sum
(
stat_dt
,data_dt
,area_nm
,branch_nm
,business_type_nm
,no_settle_cnt
,borrow_amt
,left_principa_amt
,overdue_cnt
,ovd_borrow_amt
,ovd_left_prin_amt
,m0_cnt            
,m0_borrow_amt     
,m0_left_prin_amt  
,m0_ode_prpa_amt   
,m0_ode_acal_amt   
,m0_ode_breach_amt 
,m0_ode_other_amt  
,m0_ode_amt  
,m1_cnt
,m1_borrow_amt
,m1_left_prin_amt
,m1_ode_prpa_amt
,m1_ode_acal_amt
,m1_ode_breach_amt
,m1_ode_other_amt
,m1_ode_amt
,m2_cnt
,m2_borrow_amt
,m2_left_prin_amt
,m2_ode_prpa_amt
,m2_ode_acal_amt
,m2_ode_breach_amt
,m2_ode_other_amt
,m2_ode_amt
,m3_cnt
,m3_borrow_amt
,m3_left_prin_amt
,m3_ode_prpa_amt
,m3_ode_acal_amt
,m3_ode_breach_amt
,m3_ode_other_amt
,m3_ode_amt
,m3_plus_cnt
,m3_plus_borrow_amt
,m3_plus_left_prin_amt
,m3_plus_ode_prpa_amt
,m3_plus_ode_acal_amt
,m3_plus_ode_breach_amt
,m3_plus_ode_other_amt
,m3_plus_ode_amt
,dw_src_sys
,dw_src_tbl
,dw_ins_tm
,dw_upd_tm
,dw_ins_usr
,dw_upd_usr
,part_dt
)
SELECT
 DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS stat_dt                         -- 统计日期
,DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS data_dt                         -- 数据日期  
,IFNULL(t.area_nm,'一点车贷')             AS  area_nm                                 -- 片区           
,t.branch_nm                               -- 分公司   
,t.business_type_nm                       # 业务类型             
,SUM(t.no_settle_cnt            ) AS no_settle_cnt                        -- 未结清单数     
,SUM(t.borrow_amt               ) AS borrow_amt                           -- 借款金额 
,SUM(t.borrow_amt) - SUM(t.actual_principal) AS left_principa_amt       -- 根据业务单计算 总本金 - 总实还本金    
-- ,SUM(t.left_principa_amt        ) AS left_principa_amt                    -- 剩余本金       
,SUM(t.overdue_cnt              ) AS overdue_cnt                          -- 总逾期户数     
,SUM(t.ovd_borrow_amt           ) AS ovd_borrow_amt                       -- 总逾期借款金额 
,SUM(t.ovd_left_prin_amt        ) AS ovd_left_prin_amt                    -- 总逾期剩余本金 
,SUM(t.m0_cnt                   ) AS m0_cnt                               -- m0单数                                                          
,SUM(t.m0_borrow_amt            )  AS m0_borrow_amt                        -- m0借款金额                                                     
,SUM(t.m0_left_prin_amt         ) AS m0_left_prin_amt                     -- m0剩余本金                                                      
,SUM(t.m0_ode_prpa_amt          ) AS m0_ode_prpa_amt                      -- m0逾期本金  逾期的应还本金？                                    
,SUM(t.m0_ode_acal_amt          ) AS m0_ode_acal_amt                      -- m0逾期利息                                                      
,SUM(t.m0_ode_breach_amt        ) AS m0_ode_breach_amt                    -- m0逾期滞纳金                                                    
,SUM(t.m0_ode_other_amt         ) AS m0_ode_other_amt                     -- m0逾期其他费用                                                  
,SUM(t.m0_ode_prpa_amt + t.m0_ode_acal_amt + t.m0_ode_breach_amt + t.m0_ode_other_amt) AS m0_ode_amt                           -- m0逾期总额 
,SUM(t.m1_cnt                   ) AS m1_cnt                               -- M1单数         
,SUM(t.m1_borrow_amt            )  AS m1_borrow_amt                        -- M1借款金额     
,SUM(t.m1_left_prin_amt         ) AS m1_left_prin_amt                     -- M1剩余本金     
,SUM(t.m1_ode_prpa_amt          ) AS m1_ode_prpa_amt                      -- M1逾期本金  逾期的应还本金？   
,SUM(t.m1_ode_acal_amt          ) AS m1_ode_acal_amt                      -- M1逾期利息     
,SUM(t.m1_ode_breach_amt        ) AS m1_ode_breach_amt                    -- M1逾期滞纳金   
,SUM(t.m1_ode_other_amt         ) AS m1_ode_other_amt                     -- M1逾期其他费用 
,SUM(t.m1_ode_prpa_amt + t.m1_ode_acal_amt + t.m1_ode_breach_amt + t.m1_ode_other_amt) AS m1_ode_amt                           -- M1逾期总额     
,SUM(t.m2_cnt                   ) AS m2_cnt                               -- M2单数         
,SUM(t.m2_borrow_amt            ) AS m2_borrow_amt                        -- M2借款金额     
,SUM(t.m2_left_prin_amt         ) AS m2_left_prin_amt                     -- M2剩余本金     
,SUM(t.m2_ode_prpa_amt          ) AS m2_ode_prpa_amt                      -- M2逾期本金     
,SUM(t.m2_ode_acal_amt          ) AS m2_ode_acal_amt                      -- M2逾期利息     
,SUM(t.m2_ode_breach_amt        ) AS m2_ode_breach_amt                    -- M2逾期滞纳金   
,SUM(t.m2_ode_other_amt         ) AS m2_ode_other_amt                     -- M2逾期其他费用 
,SUM(t.m2_ode_prpa_amt + t.m2_ode_acal_amt + t.m2_ode_breach_amt + t.m2_ode_other_amt) AS m2_ode_amt                            -- M2逾期总额     
,SUM(t.m3_cnt                   ) AS m3_cnt                               -- M3单数         
,SUM(t.m3_borrow_amt            ) AS m3_borrow_amt                        -- M3借款金额     
,SUM(t.m3_left_prin_amt         ) AS m3_left_prin_amt                     -- M3剩余本金     
,SUM(t.m3_ode_prpa_amt          ) AS m3_ode_prpa_amt                      -- M3逾期本金     
,SUM(t.m3_ode_acal_amt          ) AS m3_ode_acal_amt                      -- M3逾期利息     
,SUM(t.m3_ode_breach_amt        ) AS m3_ode_breach_amt                    -- M3逾期滞纳金   
,SUM(t.m3_ode_other_amt         ) AS m3_ode_other_amt                     -- M3逾期其他费用 
,SUM(t.m3_ode_prpa_amt + t.m3_ode_acal_amt + t.m3_ode_breach_amt + t.m3_ode_other_amt) AS m3_ode_amt                            -- M3逾期总额     
,SUM(t.m3_plus_cnt              ) AS m3_plus_cnt                          -- M3+单数        
,SUM(t.m3_plus_borrow_amt       ) AS m3_plus_borrow_amt                   -- M3+借款金额    
,SUM(t.m3_plus_left_prin_amt    ) AS m3_plus_left_prin_amt                -- M3+剩余本金    
,SUM(t.m3_plus_ode_prpa_amt     ) AS m3_plus_ode_prpa_amt                 -- M3+逾期本金    
,SUM(t.m3_plus_ode_acal_amt     ) AS m3_plus_ode_acal_amt                 -- M3+逾期利息    
,SUM(t.m3_plus_ode_breach_amt   ) AS m3_plus_ode_breach_amt               -- M3+逾期滞纳金  
,SUM(t.m3_plus_ode_other_amt    ) AS m3_plus_ode_other_amt                -- M3+逾期其他费用
,SUM(t.m3_plus_ode_prpa_amt + t.m3_plus_ode_acal_amt + t.m3_plus_ode_breach_amt + t.m3_plus_ode_other_amt) AS m3_plus_ode_amt                      -- M3+逾期总额 
, 'tuandai_bm' AS dw_src_sys
, 'dma_ceo_rpt_overdue_detail' AS dw_src_tbl
, CURRENT_TIMESTAMP AS dw_ins_tm
, CURRENT_TIMESTAMP AS dw_upd_tm
, 'caihl' AS dw_ins_usr
, 'caihl' AS dw_upd_usr
, DATE_FORMAT('${pt_day}','%Y-%m-%d')	AS	part_dt	     --	分区日期
FROM dma_ceo_rpt_overdue_sum_tmp t
WHERE t.business_id NOT LIKE 'CDJK%'  -- 20180822 李芳要求剔除CDJK单
GROUP BY
 IFNULL(t.area_nm,'一点车贷')                                 -- 片区           
,t.branch_nm                               -- 分公司   
,t.business_type_nm                       # 业务类型  
;


 -- 20180822 李芳要求剔除CDJK单   单独插入结果表
ALTER TABLE DMA_CEO_RPT_DATA.dma_ceo_rpt_cdjk_overdue_sum TRUNCATE PARTITION dma_ceo_rpt_cdjk_overdue_sum_${pt_day};

INSERT INTO DMA_CEO_RPT_DATA.dma_ceo_rpt_cdjk_overdue_sum
(
stat_dt
,data_dt
,area_nm
,branch_nm
,business_type_nm
,no_settle_cnt
,borrow_amt
,left_principa_amt
,overdue_cnt
,ovd_borrow_amt
,ovd_left_prin_amt
,m0_cnt            
,m0_borrow_amt     
,m0_left_prin_amt  
,m0_ode_prpa_amt   
,m0_ode_acal_amt   
,m0_ode_breach_amt 
,m0_ode_other_amt  
,m0_ode_amt  
,m1_cnt
,m1_borrow_amt
,m1_left_prin_amt
,m1_ode_prpa_amt
,m1_ode_acal_amt
,m1_ode_breach_amt
,m1_ode_other_amt
,m1_ode_amt
,m2_cnt
,m2_borrow_amt
,m2_left_prin_amt
,m2_ode_prpa_amt
,m2_ode_acal_amt
,m2_ode_breach_amt
,m2_ode_other_amt
,m2_ode_amt
,m3_cnt
,m3_borrow_amt
,m3_left_prin_amt
,m3_ode_prpa_amt
,m3_ode_acal_amt
,m3_ode_breach_amt
,m3_ode_other_amt
,m3_ode_amt
,m3_plus_cnt
,m3_plus_borrow_amt
,m3_plus_left_prin_amt
,m3_plus_ode_prpa_amt
,m3_plus_ode_acal_amt
,m3_plus_ode_breach_amt
,m3_plus_ode_other_amt
,m3_plus_ode_amt
,dw_src_sys
,dw_src_tbl
,dw_ins_tm
,dw_upd_tm
,dw_ins_usr
,dw_upd_usr
,part_dt
)
SELECT
 DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS stat_dt                         -- 统计日期
,DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS data_dt                         -- 数据日期  
,IFNULL(t.area_nm,'一点车贷')             AS  area_nm                                 -- 片区           
,t.branch_nm                               -- 分公司   
,t.business_type_nm                       # 业务类型             
,SUM(t.no_settle_cnt            ) AS no_settle_cnt                        -- 未结清单数     
,SUM(t.borrow_amt               ) AS borrow_amt                           -- 借款金额 
,SUM(t.borrow_amt) - SUM(t.actual_principal) AS left_principa_amt       -- 根据业务单计算 总本金 - 总实还本金    
-- ,SUM(t.left_principa_amt        ) AS left_principa_amt                    -- 剩余本金       
,SUM(t.overdue_cnt              ) AS overdue_cnt                          -- 总逾期户数     
,SUM(t.ovd_borrow_amt           ) AS ovd_borrow_amt                       -- 总逾期借款金额 
,SUM(t.ovd_left_prin_amt        ) AS ovd_left_prin_amt                    -- 总逾期剩余本金 
,SUM(t.m0_cnt                   ) AS m0_cnt                               -- m0单数                                                          
,SUM(t.m0_borrow_amt            )  AS m0_borrow_amt                        -- m0借款金额                                                     
,SUM(t.m0_left_prin_amt         ) AS m0_left_prin_amt                     -- m0剩余本金                                                      
,SUM(t.m0_ode_prpa_amt          ) AS m0_ode_prpa_amt                      -- m0逾期本金  逾期的应还本金？                                    
,SUM(t.m0_ode_acal_amt          ) AS m0_ode_acal_amt                      -- m0逾期利息                                                      
,SUM(t.m0_ode_breach_amt        ) AS m0_ode_breach_amt                    -- m0逾期滞纳金                                                    
,SUM(t.m0_ode_other_amt         ) AS m0_ode_other_amt                     -- m0逾期其他费用                                                  
,SUM(t.m0_ode_prpa_amt + t.m0_ode_acal_amt + t.m0_ode_breach_amt + t.m0_ode_other_amt) AS m0_ode_amt                           -- m0逾期总额 
,SUM(t.m1_cnt                   ) AS m1_cnt                               -- M1单数         
,SUM(t.m1_borrow_amt            )  AS m1_borrow_amt                        -- M1借款金额     
,SUM(t.m1_left_prin_amt         ) AS m1_left_prin_amt                     -- M1剩余本金     
,SUM(t.m1_ode_prpa_amt          ) AS m1_ode_prpa_amt                      -- M1逾期本金  逾期的应还本金？   
,SUM(t.m1_ode_acal_amt          ) AS m1_ode_acal_amt                      -- M1逾期利息     
,SUM(t.m1_ode_breach_amt        ) AS m1_ode_breach_amt                    -- M1逾期滞纳金   
,SUM(t.m1_ode_other_amt         ) AS m1_ode_other_amt                     -- M1逾期其他费用 
,SUM(t.m1_ode_prpa_amt + t.m1_ode_acal_amt + t.m1_ode_breach_amt + t.m1_ode_other_amt) AS m1_ode_amt                           -- M1逾期总额     
,SUM(t.m2_cnt                   ) AS m2_cnt                               -- M2单数         
,SUM(t.m2_borrow_amt            ) AS m2_borrow_amt                        -- M2借款金额     
,SUM(t.m2_left_prin_amt         ) AS m2_left_prin_amt                     -- M2剩余本金     
,SUM(t.m2_ode_prpa_amt          ) AS m2_ode_prpa_amt                      -- M2逾期本金     
,SUM(t.m2_ode_acal_amt          ) AS m2_ode_acal_amt                      -- M2逾期利息     
,SUM(t.m2_ode_breach_amt        ) AS m2_ode_breach_amt                    -- M2逾期滞纳金   
,SUM(t.m2_ode_other_amt         ) AS m2_ode_other_amt                     -- M2逾期其他费用 
,SUM(t.m2_ode_prpa_amt + t.m2_ode_acal_amt + t.m2_ode_breach_amt + t.m2_ode_other_amt) AS m2_ode_amt                            -- M2逾期总额     
,SUM(t.m3_cnt                   ) AS m3_cnt                               -- M3单数         
,SUM(t.m3_borrow_amt            ) AS m3_borrow_amt                        -- M3借款金额     
,SUM(t.m3_left_prin_amt         ) AS m3_left_prin_amt                     -- M3剩余本金     
,SUM(t.m3_ode_prpa_amt          ) AS m3_ode_prpa_amt                      -- M3逾期本金     
,SUM(t.m3_ode_acal_amt          ) AS m3_ode_acal_amt                      -- M3逾期利息     
,SUM(t.m3_ode_breach_amt        ) AS m3_ode_breach_amt                    -- M3逾期滞纳金   
,SUM(t.m3_ode_other_amt         ) AS m3_ode_other_amt                     -- M3逾期其他费用 
,SUM(t.m3_ode_prpa_amt + t.m3_ode_acal_amt + t.m3_ode_breach_amt + t.m3_ode_other_amt) AS m3_ode_amt                            -- M3逾期总额     
,SUM(t.m3_plus_cnt              ) AS m3_plus_cnt                          -- M3+单数        
,SUM(t.m3_plus_borrow_amt       ) AS m3_plus_borrow_amt                   -- M3+借款金额    
,SUM(t.m3_plus_left_prin_amt    ) AS m3_plus_left_prin_amt                -- M3+剩余本金    
,SUM(t.m3_plus_ode_prpa_amt     ) AS m3_plus_ode_prpa_amt                 -- M3+逾期本金    
,SUM(t.m3_plus_ode_acal_amt     ) AS m3_plus_ode_acal_amt                 -- M3+逾期利息    
,SUM(t.m3_plus_ode_breach_amt   ) AS m3_plus_ode_breach_amt               -- M3+逾期滞纳金  
,SUM(t.m3_plus_ode_other_amt    ) AS m3_plus_ode_other_amt                -- M3+逾期其他费用
,SUM(t.m3_plus_ode_prpa_amt + t.m3_plus_ode_acal_amt + t.m3_plus_ode_breach_amt + t.m3_plus_ode_other_amt) AS m3_plus_ode_amt                      -- M3+逾期总额 
, 'tuandai_bm' AS dw_src_sys
, 'dma_ceo_rpt_overdue_detail' AS dw_src_tbl
, CURRENT_TIMESTAMP AS dw_ins_tm
, CURRENT_TIMESTAMP AS dw_upd_tm
, 'caihl' AS dw_ins_usr
, 'caihl' AS dw_upd_usr
, DATE_FORMAT('${pt_day}','%Y-%m-%d')	AS	part_dt	     --	分区日期
FROM dma_ceo_rpt_overdue_sum_tmp t
WHERE t.business_id LIKE 'CDJK%'
GROUP BY
 IFNULL(t.area_nm,'一点车贷')                                 -- 片区           
,t.branch_nm                               -- 分公司   
,t.business_type_nm                       # 业务类型  
;

 INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第2步骤 汇总插入到目标表>>>end', '100', 'dma_ceo_rpt_overdue_sum', 0,'${pt_day}',  NOW(),  'caihl' );  



/*统计逾期明细排除CDJK单根据业务类型和逾期阶段进行汇总 begin*/
DROP TEMPORARY TABLE IF EXISTS dma_ceo_rpt_overdue_detail_not_cdjk_stats_tmp;
CREATE TEMPORARY TABLE `dma_ceo_rpt_overdue_detail_not_cdjk_stats_tmp` (
  `data_dt` VARCHAR(10) DEFAULT NULL,
  `business_type_nm` VARCHAR(50) DEFAULT NULL COMMENT '业务类型',
  `overdue_stage` VARCHAR(5) DEFAULT NULL COMMENT '逾期阶段',
  `borrow_amt` DECIMAL(34,2) NOT NULL DEFAULT '0',
  `left_principa_amt` DECIMAL(34,2) NOT NULL DEFAULT '0',
  `receive_principal` DECIMAL(34,2) DEFAULT NULL,
  `receive_interest` DECIMAL(34,2) DEFAULT NULL,
  `receive_platform_delaying_payment` DECIMAL(37,2) DEFAULT NULL,
  `receive_other_fee` DECIMAL(34,2) DEFAULT NULL,
  `receive_little` DECIMAL(41,2) DEFAULT NULL,
  `receive_total` DECIMAL(41,2) DEFAULT NULL,
  `actual_principal` DECIMAL(34,2) DEFAULT NULL,
  `actual_interest` DECIMAL(34,2) DEFAULT NULL,
  `actual_other_fee` DECIMAL(34,2) DEFAULT NULL,
  `actual_delaying_payment` DECIMAL(34,2) DEFAULT NULL,
  `actual_little` DECIMAL(41,2) DEFAULT NULL,
  `actual_total` DECIMAL(41,2) DEFAULT NULL
) ENGINE=INNODB DEFAULT CHARSET=utf8
;

INSERT INTO dma_ceo_rpt_overdue_detail_not_cdjk_stats_tmp
SELECT 
 DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS data_dt                  
 ,t.business_type_nm    
 ,t.overdue_stage    AS overdue_stage                
 ,0 AS borrow_amt
 ,0 AS left_principa_amt                          
  ,SUM(IFNULL(t.receive_principal, 0)) AS receive_principal
  ,SUM(IFNULL(t.receive_interest, 0))  AS receive_interest
  ,SUM(IFNULL(t.receive_platform_delaying_payment, 0)) AS receive_platform_delaying_payment
  ,SUM(IFNULL(t.receive_other_fee, 0)) AS receive_other_fee
  ,SUM(IFNULL(t.receive_little, 0)) AS receive_little
  ,SUM(IFNULL(t.receive_total, 0)) AS receive_total
  ,SUM(IFNULL(t.actual_principal, 0)) AS actual_principal
  ,SUM(IFNULL(t.actual_interest, 0)) AS actual_interest
  ,SUM(IFNULL(t.actual_other_fee, 0)) AS actual_other_fee
  ,SUM(IFNULL(t.actual_delaying_payment, 0)) AS actual_delaying_payment
  ,SUM(IFNULL(t.actual_little, 0)) AS actual_little
  ,SUM(IFNULL(t.actual_total, 0)) AS actual_total
FROM
  DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail t
  WHERE t.part_dt =DATE'${pt_day}'
  AND  t.max_ovd_days >0
  AND  t.business_id NOT LIKE 'CDJK%'
GROUP BY 
 t.business_type_nm
,t.overdue_stage
;


INSERT INTO dma_ceo_rpt_overdue_detail_not_cdjk_stats_tmp
SELECT 
 DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS data_dt
,business_type_nm
,max_overdue_stage                 AS overdue_stage
,SUM(IFNULL(borrow_amt, 0))        AS borrow_amt
,SUM(IFNULL(left_principa_amt, 0)) AS left_principa_amt
 ,0 AS receive_principal                
 ,0 AS receive_interest                 
 ,0 AS receive_other_fee                
 ,0 AS receive_platform_delaying_payment
 ,0 AS receive_little                   
 ,0 AS receive_total                    
 ,0 AS actual_principal                 
 ,0 AS actual_interest                  
 ,0 AS actual_other_fee                 
 ,0 AS actual_delaying_payment          
 ,0 AS actual_little                    
 ,0 AS actual_total     
FROM (SELECT 
 t.business_id
,t.business_type_nm
  ,(CASE WHEN t.max_ovd_days &lt;= 0 THEN '未逾期'
      WHEN t.max_ovd_days &lt; 31  THEN 'M1'
      WHEN t.max_ovd_days &lt; 61  THEN 'M2'
      WHEN t.max_ovd_days &lt; 91  THEN 'M3'
      WHEN t.max_ovd_days >= 91  THEN 'M3+'
 END)  AS  max_overdue_stage 
,MAX(max_ovd_days)        AS  max_ovd_days                    -- 最大逾期天数               
,MAX(t.borrow_amt)        AS borrow_amt
,MAX(t.left_principa_amt) AS left_principa_amt
FROM
  DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail t
  WHERE t.part_dt =DATE'${pt_day}'
   AND  t.max_ovd_days >0
   AND  t.business_id NOT LIKE 'CDJK%'
GROUP BY 
 t.business_id
,t.business_type_nm
  ,(CASE WHEN t.max_ovd_days &lt;= 0 THEN '未逾期'
      WHEN t.max_ovd_days &lt; 31  THEN 'M1'
      WHEN t.max_ovd_days &lt; 61  THEN 'M2'
      WHEN t.max_ovd_days &lt; 91  THEN 'M3'
      WHEN t.max_ovd_days >= 91  THEN 'M3+'
 END)  
) tt 
GROUP BY 
 business_type_nm 
,max_overdue_stage 
;

 INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第3步骤 dma_ceo_rpt_overdue_detail_not_cdjk_stats_tmp', '100', 'dma_ceo_rpt_overdue_sum', 0,'${pt_day}',  NOW(),  'caihl' );  


/*李芳要求每天导出逾期天数大于0的汇总数据*/
DELETE FROM DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail_not_cdjk_stats WHERE data_dt=DATE_FORMAT('${pt_day}','%Y-%m-%d');
INSERT INTO DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail_not_cdjk_stats
SELECT 
 DATE_FORMAT('${pt_day}','%Y-%m-%d')  AS data_dt                 
,t.business_type_nm AS business_type_nm  
,t.overdue_stage AS overdue_stage                     
 ,SUM(IFNULL(t.borrow_amt, 0))        AS borrow_amt
 ,SUM(IFNULL(t.left_principa_amt, 0)) AS left_principa_amt                        
  ,SUM(IFNULL(t.receive_principal, 0)) AS receive_principal
  ,SUM(IFNULL(t.receive_interest, 0))  AS receive_interest
  ,SUM(IFNULL(t.receive_platform_delaying_payment, 0)) AS receive_platform_delaying_payment
  ,SUM(IFNULL(t.receive_other_fee, 0)) AS receive_other_fee
  ,SUM(IFNULL(t.receive_little, 0)) AS receive_little
  ,SUM(IFNULL(t.receive_total, 0)) AS receive_total
  ,SUM(IFNULL(t.actual_principal, 0)) AS actual_principal
  ,SUM(IFNULL(t.actual_interest, 0)) AS actual_interest
  ,SUM(IFNULL(t.actual_other_fee, 0)) AS actual_other_fee
  ,SUM(IFNULL(t.actual_delaying_payment, 0)) AS actual_delaying_payment
  ,SUM(IFNULL(t.actual_little, 0)) AS actual_little
  ,SUM(IFNULL(t.actual_total, 0)) AS actual_total
 ,'tuandai_bm' AS dw_src_sys
 ,'dma_ceo_rpt_overdue_detail' AS dw_src_tbl
 ,CURRENT_TIMESTAMP AS dw_ins_tm
 ,CURRENT_TIMESTAMP AS dw_upd_tm
 ,'caihl' AS dw_ins_usr
 ,'caihl' AS dw_upd_usr
FROM dma_ceo_rpt_overdue_detail_not_cdjk_stats_tmp  t
GROUP BY
 t.business_type_nm
,t.overdue_stage
;

 INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第4步骤 not_cdjk_stats目标表生成>>>end', '100', 'dma_ceo_rpt_overdue_sum', 0,'${pt_day}',  NOW(),  'caihl' );  

/*统计逾期明细排除CDJK单根据业务类型和逾期阶段进行汇总 end*/

 
/*房速贷m3阶段逾期明细数据(粒度到业务单号)用于每周一发给黄总 begin */
DROP TEMPORARY TABLE IF EXISTS dma_ceo_rpt_overdue_detail_fsd_m3plus_tmp;
CREATE TEMPORARY TABLE `dma_ceo_rpt_overdue_detail_fsd_m3plus_tmp` (
  `business_id` VARCHAR(50) DEFAULT NULL COMMENT '业务编号',
  `business_type_nm` VARCHAR(50) DEFAULT NULL COMMENT '业务类型',
  `max_overdue_stage` VARCHAR(20) DEFAULT NULL,
  `max_ovd_days` INT(7) DEFAULT NULL COMMENT '最大逾期天数',
  `borrow_amt` DECIMAL(12,2) DEFAULT 0.00 COMMENT '借款金额',
  `left_principa_amt` DECIMAL(12,2) DEFAULT 0.00 COMMENT '剩余本金',
  KEY idx_business_id(business_id)
) ENGINE=INNODB DEFAULT CHARSET=utf8
;

INSERT INTO dma_ceo_rpt_overdue_detail_fsd_m3plus_tmp
SELECT DISTINCT
 t.business_id
,t.business_type_nm
,(CASE WHEN t.max_ovd_days &lt;= 0 THEN '未逾期'
      WHEN t.max_ovd_days &lt; 31  THEN 'M1'
      WHEN t.max_ovd_days &lt; 61  THEN 'M2'
      WHEN t.max_ovd_days &lt; 91  THEN 'M3'
      WHEN t.max_ovd_days >= 91  THEN 'M3+'
 END)  AS  max_overdue_stage 
,(max_ovd_days)        AS  max_ovd_days                    -- 最大逾期天数               
,(t.borrow_amt)        AS borrow_amt
,(t.left_principa_amt) AS left_principa_amt
FROM
  DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail t
  WHERE t.part_dt =DATE_FORMAT('${pt_day}','%Y-%m-%d')
   AND  t.max_ovd_days >90
   AND t.`business_type_nm` IN ('房速贷')
   ;
 
  INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第5步骤 dma_ceo_rpt_overdue_detail_fsd_m3plus_tmp', '100', 'dma_ceo_rpt_overdue_detail_fsd_m3plus', 0,'${pt_day}',  NOW(),  'caihl' );  



 DROP TEMPORARY TABLE IF EXISTS tb_fsd_house_ods_tmp;
 CREATE TEMPORARY TABLE `tb_fsd_house_ods_tmp` (
  `business_id` VARCHAR(50) NOT NULL COMMENT '[业务编号]',
  `HOUSE_NO` VARCHAR(1000) NULL ,
  `house_shi` VARCHAR(1000) NULL ,
  `ower_name` VARCHAR(1000) NULL ,
  KEY idx_business_id(business_id)
) ENGINE=INNODB DEFAULT CHARSET=utf8
;
 
INSERT INTO `tb_fsd_house_ods_tmp` 
SELECT business_id,GROUP_CONCAT(HOUSE_NO) AS HOUSE_NO,GROUP_CONCAT(house_shi) AS house_shi ,GROUP_CONCAT(house_name) AS ower_name
FROM ODS_XD_TUANDAI_BM.tb_fsd_house_ods  
WHERE part_dt =DATE_FORMAT('${pt_day}','%Y-%m-%d') 
GROUP BY  business_id
;
   
  INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第6步骤 tb_fsd_house_ods_tmp', '100', 'dma_ceo_rpt_overdue_detail_fsd_m3plus', 0,'${pt_day}',  NOW(),  'caihl' );  


ALTER TABLE DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail_fsd_m3plus TRUNCATE PARTITION dma_ceo_rpt_overdue_detail_fsd_m3plus_${pt_day};
INSERT INTO DMA_CEO_RPT_DATA.dma_ceo_rpt_overdue_detail_fsd_m3plus
SELECT DISTINCT
 DATE_FORMAT('${pt_day}','%Y%m%d') AS data_dt-- 数据日期
,a.business_id         -- 业务编号        
,a.business_type_nm    -- 业务类型        
,a.max_overdue_stage   -- 逾期阶段                   
,a.max_ovd_days        -- 最大逾期天数  
,a.borrow_amt          -- 借款金额        
,a.left_principa_amt   -- 剩余本金
,'房抵押'             AS pledge_mode -- '担保方式'
,CASE WHEN IFNULL(g.ower_name,'')!='' THEN g.ower_name ELSE g.ower_name END AS ower_name-- '担保权属人'
,CASE WHEN IFNULL(g.house_shi,'')!='' THEN g.house_shi ELSE g.house_shi END AS house_shi-- '权属地'
,CASE WHEN IFNULL(g.house_no,'')!='' THEN g.HOUSE_NO ELSE g.HOUSE_NO END    AS house_no -- '房产证编号'
,CASE WHEN IFNULL(u.creditor_or_lender_name,'')!='' THEN u.creditor_or_lender_name ELSE v.Pledee END AS creditor_or_lender_name --  '抵押权人' 
,cust.customer_name               AS customer_name-- "客户姓名"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
,cust.customer_type               AS customer_type-- "客户类型 企业/个人"                                                                                                                                                                                                                                                                                                                                                          
,CONCAT("'",cust.identify_card)   AS identify_card-- "身份证号码"                                                                                                                                                                                                                                                                                                                                                
,cust.phone_number                AS phone_number -- "手机号码"   
,'tuandai_bm' AS dw_src_sys
,'dma_ceo_rpt_overdue_detail,tb_fsd_house_ods,tb_business_output_ods,tb_creditor_ods,tb_fsd_customer_ods' AS dw_src_tbl
,CURRENT_TIMESTAMP AS dw_ins_tm
,CURRENT_TIMESTAMP AS dw_upd_tm
,'caihl'           AS dw_ins_usr
,'caihl'           AS dw_upd_usr
,DATE_FORMAT('${pt_day}','%Y-%m-%d')	AS	part_dt	     --	分区日期                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
FROM dma_ceo_rpt_overdue_detail_fsd_m3plus_tmp a 
LEFT JOIN tb_fsd_house_ods_tmp g ON a.business_id=g.business_id
-- LEFT JOIN (SELECT business_id,GROUP_CONCAT(house_name) AS ower_name FROM ODS_XD_TUANDAI_BM.tb_fsd_house_ods where part_dt =DATE_FORMAT('${pt_day}','%Y-%m-%d') GROUP BY  business_id) h ON a.business_id=h.business_id
LEFT JOIN (SELECT v.BUSINESS_ID ,v.Pledee,v.Pledee_ID FROM ODS_XD_TUANDAI_BM.tb_business_output_ods v WHERE  v.part_dt =DATE_FORMAT('${pt_day}','%Y-%m-%d')) v ON a.business_id=v.BUSINESS_ID 
LEFT JOIN (SELECT u.creditor_id,u.creditor_or_lender_name FROM ODS_XD_TUANDAI_BM.tb_creditor_ods u WHERE u.part_dt =DATE_FORMAT('${pt_day}','%Y-%m-%d'))u  ON v.Pledee_ID=u.creditor_id 
LEFT JOIN (SELECT cust.business_id 
                 ,cust.customer_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                 ,cust.customer_type                                                                                                                                                                                                                                                                                                                                                          
                 ,cust.identify_card                                                                                                                                                                                                                                                                                                                                        
                 ,cust.phone_number
FROM ODS_XD_TUANDAI_BM.`tb_fsd_customer_ods` cust  WHERE cust.ismain_customer=1 AND cust.part_dt =DATE_FORMAT('${pt_day}','%Y-%m-%d')) cust ON a.business_id = cust.business_id
;
  INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','第7步骤 dma_ceo_rpt_overdue_detail_fsd_m3plus>>end', '100', 'dma_ceo_rpt_overdue_detail_fsd_m3plus', 0,'${pt_day}',  NOW(),  'caihl' );  

/*房速贷m3阶段逾期明细数据(粒度到业务单号)用于每周一发给黄总 end */</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>DMA_SAL_ACHV_DATA</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>816</xloc>
      <yloc>496</yloc>
    </entry>
  </entries>
  <hops>
    <hop>
      <from>START</from>
      <to>SQL_LOG 100</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>Y</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 400</from>
      <to>DUMMY</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 210</from>
      <to>JavaScript_Return</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>ktr_set_date</from>
      <to>SQL_LOG 200</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 310</from>
      <to>JavaScript_Return</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 100</from>
      <to>Set variables</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Set variables</from>
      <to>ktr_set_date</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 200</from>
      <to>ktr_duty_check</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>ktr_duty_check</from>
      <to>check_value</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>check_value</from>
      <to>SQL_LOG 210 2 2</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 210 2 2</from>
      <to>Java_cycle</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Java_cycle</from>
      <to>Wait for</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Wait for</from>
      <to>ktr_duty_check</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>ktr_duty_insert</from>
      <to>SQL_LOG 400</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>delete_data 2</from>
      <to>SQL_LOG 300</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>delete_data 2</from>
      <to>SQL_LOG 210</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>check_value</from>
      <to>delete_data 2</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Java_cycle</from>
      <to>SQL_LOG 120</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 120</from>
      <to>JavaScript_Return</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 300</from>
      <to>insert_data</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>insert_data</from>
      <to>SQL_LOG 310</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>insert_data</from>
      <to>ktr_duty_insert</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
  </hops>
  <notepads>
    <notepad>
      <note>*************************							
功      能 ：ceo看板逾期汇总表
创建时间：20180508
创建人   ：caihl
源系统	 ：tuandai_bm
数据源表：
房速贷 车易贷、
dma_ceo_rpt_overdue_detail
一点车贷：
dma_ceo_rpt_overdue_detail


运行频率：天
注意事项： 
问题发现： 
修改记录： 
***********************
20180522  caihl  排除未结清的数据
20180530 caihl   修改overdue_cnt逾期总户数的逻辑
20180530 caihl  直接从逾期明细中取数（一点和房车公用）
20180607 caihl   临时表group by加入 ,t.business_type_nm 
20180903 caihl  统计逾期明细排除CDJK单根据业务类型和逾期阶段进行汇总
20181008 caihl  dma_ceo_rpt_overdue_detail_not_cdjk_stats 取最大逾期天数大于0的数据而不是当前逾期天数
20181009 caihl  新增表dma_ceo_rpt_overdue_detail_fsd_m3plus （房速贷m3阶段逾期明细数据(粒度到业务单号)用于每周一发给黄总）</note>
      <xloc>16</xloc>
      <yloc>0</yloc>
      <width>752</width>
      <heigth>397</heigth>
      <fontname>Microsoft YaHei UI</fontname>
      <fontsize>9</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>0</fontcolorred>
      <fontcolorgreen>0</fontcolorgreen>
      <fontcolorblue>0</fontcolorblue>
      <backgroundcolorred>192</backgroundcolorred>
      <backgroundcolorgreen>192</backgroundcolorgreen>
      <backgroundcolorblue>192</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <attributes>
    <group>
      <name>METASTORE.pentaho</name>
      <attribute>
        <key>Default Run Configuration</key>
        <value>{"namespace":"pentaho","id":"Default Run Configuration","name":"Default Run Configuration","description":"Defines a default run configuration","metaStoreName":null}</value>
      </attribute>
    </group>
    <group>
      <name>{"_":"Embedded MetaStore Elements","namespace":"pentaho","type":"Default Run Configuration"}</name>
      <attribute>
        <key>Pentaho local</key>
        <value>{"children":[{"children":[],"id":"server","value":null},{"children":[],"id":"clustered","value":"N"},{"children":[],"id":"name","value":"Pentaho local"},{"children":[],"id":"description","value":null},{"children":[],"id":"pentaho","value":"N"},{"children":[],"id":"readOnly","value":"Y"},{"children":[],"id":"sendResources","value":"N"},{"children":[],"id":"logRemoteExecutionLocally","value":"N"},{"children":[],"id":"remote","value":"N"},{"children":[],"id":"local","value":"Y"},{"children":[],"id":"showTransformations","value":"N"}],"id":"Pentaho local","value":null,"name":"Pentaho local","owner":null,"ownerPermissionsList":[]}</value>
      </attribute>
    </group>
  </attributes>
</job>
