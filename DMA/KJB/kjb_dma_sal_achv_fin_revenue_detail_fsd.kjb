<?xml version="1.0" encoding="UTF-8"?>
<job>
  <name>kjb_dma_sal_achv_fin_revenue_detail_fsd</name>
  <description/>
  <extended_description/>
  <job_version/>
  <job_status>0</job_status>
  <directory>/</directory>
  <created_user>-</created_user>
  <created_date>2018/01/26 14:01:05.270</created_date>
  <modified_user>-</modified_user>
  <modified_date>2018/01/31 11:51:34.108</modified_date>
  <parameters>
    <parameter>
      <name>p_day</name>
      <default_value>20180328</default_value>
      <description/>
    </parameter>
    <parameter>
      <name>p_duty_nm</name>
      <default_value>dma_sal_achv_fin_revenue_detail_fsd</default_value>
      <description/>
    </parameter>
  </parameters>
  <connection>
    <name>DMA_SAL_ACHV_DATA</name>
    <server>${UAT_DC_DB_HOST}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${UAT_DC_DB_DMA_SAL_ACHVNAME}</database>
    <port>3306</port>
    <username>${UAT_DC_DB_USER}</username>
    <password>${UAT_DC_DB_PWD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.characterEncoding</code>
        <attribute>utf8</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>public_data</name>
    <server>${UAT_DC_DB_HOST}</server>
    <type>MYSQL</type>
    <access>Native</access>
    <database>${UAT_DC_DB_PUBLIC_NAME}</database>
    <port>3306</port>
    <username>${UAT_DC_DB_USER}</username>
    <password>${UAT_DC_DB_PWD}</password>
    <servername/>
    <data_tablespace/>
    <index_tablespace/>
    <attributes>
      <attribute>
        <code>EXTRA_OPTION_MYSQL.characterEncoding</code>
        <attribute>utf8</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>3306</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>STREAM_RESULTS</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <slaveservers>
    </slaveservers>
  <job-log-table>
    <connection>public_data</connection>
    <schema/>
    <table>TRANS_LOG</table>
    <size_limit_lines/>
    <interval/>
    <timeout_days/>
    <field>
      <id>ID_JOB</id>
      <enabled>Y</enabled>
      <name>ID_JOB</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>JOBNAME</name>
    </field>
    <field>
      <id>STATUS</id>
      <enabled>Y</enabled>
      <name>STATUS</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>STARTDATE</id>
      <enabled>Y</enabled>
      <name>STARTDATE</name>
    </field>
    <field>
      <id>ENDDATE</id>
      <enabled>Y</enabled>
      <name>ENDDATE</name>
    </field>
    <field>
      <id>LOGDATE</id>
      <enabled>Y</enabled>
      <name>LOGDATE</name>
    </field>
    <field>
      <id>DEPDATE</id>
      <enabled>Y</enabled>
      <name>DEPDATE</name>
    </field>
    <field>
      <id>REPLAYDATE</id>
      <enabled>Y</enabled>
      <name>REPLAYDATE</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>Y</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>EXECUTING_SERVER</id>
      <enabled>N</enabled>
      <name>EXECUTING_SERVER</name>
    </field>
    <field>
      <id>EXECUTING_USER</id>
      <enabled>N</enabled>
      <name>EXECUTING_USER</name>
    </field>
    <field>
      <id>START_JOB_ENTRY</id>
      <enabled>N</enabled>
      <name>START_JOB_ENTRY</name>
    </field>
    <field>
      <id>CLIENT</id>
      <enabled>N</enabled>
      <name>CLIENT</name>
    </field>
  </job-log-table>
  <jobentry-log-table>
    <connection/>
    <schema/>
    <table/>
    <timeout_days/>
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>JOBNAME</id>
      <enabled>Y</enabled>
      <name>TRANSNAME</name>
    </field>
    <field>
      <id>JOBENTRYNAME</id>
      <enabled>Y</enabled>
      <name>STEPNAME</name>
    </field>
    <field>
      <id>LINES_READ</id>
      <enabled>Y</enabled>
      <name>LINES_READ</name>
    </field>
    <field>
      <id>LINES_WRITTEN</id>
      <enabled>Y</enabled>
      <name>LINES_WRITTEN</name>
    </field>
    <field>
      <id>LINES_UPDATED</id>
      <enabled>Y</enabled>
      <name>LINES_UPDATED</name>
    </field>
    <field>
      <id>LINES_INPUT</id>
      <enabled>Y</enabled>
      <name>LINES_INPUT</name>
    </field>
    <field>
      <id>LINES_OUTPUT</id>
      <enabled>Y</enabled>
      <name>LINES_OUTPUT</name>
    </field>
    <field>
      <id>LINES_REJECTED</id>
      <enabled>Y</enabled>
      <name>LINES_REJECTED</name>
    </field>
    <field>
      <id>ERRORS</id>
      <enabled>Y</enabled>
      <name>ERRORS</name>
    </field>
    <field>
      <id>RESULT</id>
      <enabled>Y</enabled>
      <name>RESULT</name>
    </field>
    <field>
      <id>NR_RESULT_ROWS</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_ROWS</name>
    </field>
    <field>
      <id>NR_RESULT_FILES</id>
      <enabled>Y</enabled>
      <name>NR_RESULT_FILES</name>
    </field>
    <field>
      <id>LOG_FIELD</id>
      <enabled>N</enabled>
      <name>LOG_FIELD</name>
    </field>
    <field>
      <id>COPY_NR</id>
      <enabled>N</enabled>
      <name>COPY_NR</name>
    </field>
  </jobentry-log-table>
  <channel-log-table>
    <connection/>
    <schema/>
    <table/>
    <timeout_days/>
    <field>
      <id>ID_BATCH</id>
      <enabled>Y</enabled>
      <name>ID_BATCH</name>
    </field>
    <field>
      <id>CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>CHANNEL_ID</name>
    </field>
    <field>
      <id>LOG_DATE</id>
      <enabled>Y</enabled>
      <name>LOG_DATE</name>
    </field>
    <field>
      <id>LOGGING_OBJECT_TYPE</id>
      <enabled>Y</enabled>
      <name>LOGGING_OBJECT_TYPE</name>
    </field>
    <field>
      <id>OBJECT_NAME</id>
      <enabled>Y</enabled>
      <name>OBJECT_NAME</name>
    </field>
    <field>
      <id>OBJECT_COPY</id>
      <enabled>Y</enabled>
      <name>OBJECT_COPY</name>
    </field>
    <field>
      <id>REPOSITORY_DIRECTORY</id>
      <enabled>Y</enabled>
      <name>REPOSITORY_DIRECTORY</name>
    </field>
    <field>
      <id>FILENAME</id>
      <enabled>Y</enabled>
      <name>FILENAME</name>
    </field>
    <field>
      <id>OBJECT_ID</id>
      <enabled>Y</enabled>
      <name>OBJECT_ID</name>
    </field>
    <field>
      <id>OBJECT_REVISION</id>
      <enabled>Y</enabled>
      <name>OBJECT_REVISION</name>
    </field>
    <field>
      <id>PARENT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>PARENT_CHANNEL_ID</name>
    </field>
    <field>
      <id>ROOT_CHANNEL_ID</id>
      <enabled>Y</enabled>
      <name>ROOT_CHANNEL_ID</name>
    </field>
  </channel-log-table>
  <pass_batchid>N</pass_batchid>
  <shared_objects_file/>
  <entries>
    <entry>
      <name>START</name>
      <description/>
      <type>SPECIAL</type>
      <start>Y</start>
      <dummy>N</dummy>
      <repeat>N</repeat>
      <schedulerType>0</schedulerType>
      <intervalSeconds>0</intervalSeconds>
      <intervalMinutes>60</intervalMinutes>
      <hour>12</hour>
      <minutes>0</minutes>
      <weekDay>1</weekDay>
      <DayOfMonth>1</DayOfMonth>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>64</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>DUMMY</name>
      <description/>
      <type>SPECIAL</type>
      <start>N</start>
      <dummy>Y</dummy>
      <repeat>N</repeat>
      <schedulerType>0</schedulerType>
      <intervalSeconds>0</intervalSeconds>
      <intervalMinutes>60</intervalMinutes>
      <hour>12</hour>
      <minutes>0</minutes>
      <weekDay>1</weekDay>
      <DayOfMonth>1</DayOfMonth>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1104</xloc>
      <yloc>448</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 100</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('11',
   '${p_duty_nm}',
	'1',
   '>>>>>>>>>> JOB START >>>>>>>>>>',
   '100',
   '任务开始！！',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>128</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>JavaScript_Return</name>
      <description/>
      <type>EVAL</type>
      <script>1 > 2 </script>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>688</xloc>
      <yloc>720</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 300</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'insert_data',
   '100',
   '插入数据库！！',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>816</xloc>
      <yloc>368</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 400</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   '>>>>>>>>>> JOB END >>>>>>>>>>',
   '100',
   '插入数据库',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>1008</xloc>
      <yloc>288</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 310</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'ods_insert',
   '100',
   '插入数据异常',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>688</xloc>
      <yloc>592</yloc>
    </entry>
    <entry>
      <name>ktr_set_date</name>
      <description/>
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id/>
      <filename>${UAT_KTR_DIR}/PUBLIC/KTR/ktr_set_date.ktr</filename>
      <transname/>
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile/>
      <logext/>
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name/>
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>304</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 200</name>
      <description/>
      <type>SQL</type>
      <sql>insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'ktr_set_date',
   '200',
   '定义日期变量！！',
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>352</xloc>
      <yloc>304</yloc>
    </entry>
    <entry>
      <name>Set variables</name>
      <description/>
      <type>SET_VARIABLES</type>
      <replacevars>Y</replacevars>
      <filename/>
      <file_variable_type>JVM</file_variable_type>
      <fields>
        <field>
          <variable_name>i_while_count</variable_name>
          <variable_value>0</variable_value>
          <variable_type>CURRENT_JOB</variable_type>
        </field>
      </fields>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>192</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>ktr_duty_check</name>
      <description/>
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id/>
      <filename>${UAT_KTR_DIR}/PUBLIC/KTR/ktr_duty_check.ktr</filename>
      <transname/>
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile/>
      <logext/>
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name/>
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>416</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>check_value</name>
      <description/>
      <type>SIMPLE_EVAL</type>
      <valuetype>variable</valuetype>
      <fieldname>pt_returnvalue</fieldname>
      <variablename>pt_returnvalue</variablename>
      <fieldtype>number</fieldtype>
      <mask/>
      <comparevalue>0</comparevalue>
      <minvalue/>
      <maxvalue/>
      <successcondition>equal</successcondition>
      <successnumbercondition>equal</successnumbercondition>
      <successbooleancondition>false</successbooleancondition>
      <successwhenvarset>N</successwhenvarset>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>512</xloc>
      <yloc>464</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 210 2 2</name>
      <description/>
      <type>SQL</type>
      <sql>
insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'check_value',
   '100',
   CONCAT('${pt_returnvalue}','源表没有生成,需等待2分钟'),
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>512</xloc>
      <yloc>592</yloc>
    </entry>
    <entry>
      <name>Java_cycle</name>
      <description/>
      <type>EVAL</type>
      <script>var attempt = parent_job.getVariable("i_while_count");

if(attempt &lt; 10 )
{
   attempt++;
   parent_job.setVariable("i_while_count", attempt); 

   true;

}
else
{
   

   false;
}
</script>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>448</xloc>
      <yloc>720</yloc>
    </entry>
    <entry>
      <name>Wait for</name>
      <description/>
      <type>DELAY</type>
      <maximumTimeout>2</maximumTimeout>
      <scaletime>1</scaletime>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>416</xloc>
      <yloc>592</yloc>
    </entry>
    <entry>
      <name>ktr_duty_insert</name>
      <description/>
      <type>TRANS</type>
      <specification_method>filename</specification_method>
      <trans_object_id/>
      <filename>${UAT_KTR_DIR}/PUBLIC/KTR/ktr_duty_insert.ktr</filename>
      <transname/>
      <arg_from_previous>N</arg_from_previous>
      <params_from_previous>N</params_from_previous>
      <exec_per_row>N</exec_per_row>
      <clear_rows>N</clear_rows>
      <clear_files>N</clear_files>
      <set_logfile>N</set_logfile>
      <logfile/>
      <logext/>
      <add_date>N</add_date>
      <add_time>N</add_time>
      <loglevel>Basic</loglevel>
      <cluster>N</cluster>
      <slave_server_name/>
      <set_append_logfile>N</set_append_logfile>
      <wait_until_finished>Y</wait_until_finished>
      <follow_abort_remote>N</follow_abort_remote>
      <create_parent_folder>N</create_parent_folder>
      <logging_remote_work>N</logging_remote_work>
      <run_configuration>Pentaho local</run_configuration>
      <parameters>
        <pass_all_parameters>Y</pass_all_parameters>
      </parameters>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>928</xloc>
      <yloc>480</yloc>
    </entry>
    <entry>
      <name>insert_data</name>
      <description/>
      <type>SQL</type>
      <sql>

SET SESSION tmp_table_size=1024*1024*1024;
SET SESSION max_heap_table_size=1024*1024*1024;

INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','>>>>>>>>>> JOB START >>>>>>>>>>', '0', '总共4步！！', 0,'${p_day}',  NOW(),  'caihl' );
  
DROP TEMPORARY TABLE IF EXISTS tb_account_list_detail_tmp;
CREATE TEMPORARY TABLE tb_account_list_detail_tmp (
  settle_way  INT(1) NOT NULL DEFAULT 0 COMMENT '1表示结清 0表示未结清',-- 1表示结清 0表示未结清
  business_id VARCHAR(50) NOT NULL DEFAULT '' COMMENT '业务编号',
  after_id VARCHAR(50) NOT NULL DEFAULT '' COMMENT '期数',
  issue_id VARCHAR(50) DEFAULT '' COMMENT '标的id',
  batch_id VARCHAR(100) NOT NULL COMMENT '批次号',
  fee_id VARCHAR(50) NOT NULL DEFAULT '' COMMENT '费用id',
  fee_name VARCHAR(50) NOT NULL DEFAULT '' COMMENT '费用名称',
  amount DECIMAL(18,2) NOT NULL COMMENT '记账金额',
  account_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记账时间',
  account_date DATE DEFAULT NULL COMMENT '记账日期',
  status_flag INT(11) NOT NULL DEFAULT '1' COMMENT '状态',
  create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  create_user VARCHAR(50) NOT NULL DEFAULT '' COMMENT '创建用户',
  update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  update_user VARCHAR(50) NOT NULL DEFAULT '' COMMENT '更新用户',
  register_type INT(11) NOT NULL DEFAULT '0' COMMENT '登记类型（0：正常费用 1：冲应收费用）',
  action_id INT(11) NOT NULL DEFAULT '0' COMMENT '交易活动',
  exhibition_id VARCHAR(50) DEFAULT '' COMMENT '展期编号',
  business_type VARCHAR(50) DEFAULT '' COMMENT '业务类型',
  business_type_id VARCHAR(50) DEFAULT '' COMMENT '业务类型id',
  branch_id VARCHAR(50) DEFAULT '' COMMENT '分公司id',
  branch_name VARCHAR(50) DEFAULT '' COMMENT '分公司id',
  customer_name VARCHAR(50) DEFAULT '' COMMENT '客户名称',
  main_customer_name VARCHAR(500) DEFAULT '' COMMENT '主客户名称',
  business_from INT(11) NOT NULL DEFAULT '1' COMMENT '所属资产端',
  invest_from INT(11) NOT NULL DEFAULT '1' COMMENT '所属投资端(发标端)',
  segmentation_date DATE DEFAULT NULL COMMENT '数据分割时间点',
  KEY idx_business_id(business_id),
  KEY idx_issue_id (issue_id)
) ENGINE=INNODB DEFAULT CHARSET=utf8 COMMENT='流水费用明细表'
;

INSERT INTO tb_account_list_detail_tmp
SELECT 
(CASE WHEN t.action_id IN (3,31,32,33,35) THEN 1 ELSE 0 END) AS settle_way  -- 1表示结清 0表示未结清
,t.business_id
,t.after_id
,t.issue_id
,t.batch_id
,t.fee_id
,t.fee_name
,t.amount
,t.account_time
,t.account_date
,t.status_flag
,t.create_time
,t.create_user
,t.update_time
,t.update_user
,t.register_type
,t.action_id
,t.exhibition_id
,t.business_type
,t.business_type_id
,t.branch_id
,t.branch_name
,t.customer_name
,t.main_customer_name
,t.business_from
,t.invest_from
,t.segmentation_date
FROM ODS_XD_TUANDAI_BM.tb_account_list_detail_cams_ods t
WHERE t.part_dt = DATE_FORMAT('${pt_day}','%Y-%m-%d')
AND (t.segmentation_date >=DATE'2016-03-11' OR t.segmentation_date IS NULL) -- 由于存在为空的数据
AND t.status_flag IN (0,1)
-- AND NOT (t.action_id=0 AND (CASE WHEN t.exhibition_id ='' THEN NULL ELSE t.exhibition_id END) IS NOT NULL) -- 排除action_id=0(满标分润并且展期编号为非空的数据
AND NOT (t.action_id=0 AND t.exhibition_id &lt;&gt;'') -- 排除action_id=0(满标分润并且展期编号为非空的数据
AND t.business_type NOT IN ('一点车贷','扶贫贷','汽车垫资代采','汽车融资租赁')
AND t.business_id   NOT IN ('TDF1012017071903')  -- add by caihl20181129 TDF1012017071903 该笔属于管车所业务，但是上标用房速贷业务类型，所以本息情况表（新）屏蔽掉该笔业务，不统计。 
AND t.amount&lt;&gt;0
AND t.action_id IN (0, 2, 3, 31, 32, 33, 34, 35, 4, 6, 99) -- 核心账务action_id这些才进入到费用明细(tb_account_action该表对应action_id的名称)
;
INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','1:tb_account_list_detail_tmp取口径数据', '0', '总共4步！！', 0,'${p_day}',  NOW(),  'caihl' );

/*
4、收入明细表-房速贷(核心-业务费用明细)
********对于流水状态为撤消的对应的金额为负数

（1）分公司费用（一次性）：取“核心-业务费用明细”字段：[分公司服务费（且期数为00期的值）+调查费+展期手续费 +剩余前置服务费 +行政综合费
（2）分公司月服务费：取“核心-业务费用明细”字段：分公司服务费(非00期)+月收分公司服务费+月收分公司服务费(比例)+月收分公司服务费(金额)+逾期服务费+逾期分公司服务费+展期未结清服务费 +分公司费用(非00期)
（注：由于2017.5月前费用项没有拆分，导致现分公司服务费字段含分公司服务费（首期）和月收分公司服务费两个不同的值，故需注意此处只取期数为非00期的分公司服务费。）
（3）提前结清分公司违约金：取“核心-业务费用明细”字段：分公司月收服务费违约金+本金违约金+提前结清违约金+提前结清分公司服务费违约金+提前结清本金违约金
（4）增加两个字段：
a、拖车费、上门费合计：取“核心-业务费用明细”字段：拖车费、上门费
B、诉讼发生费用合计：取“核心-业务费用明细”字段：仲裁费+保全费+公告费+律师费+评估费+咨询费+诉讼费+鉴定费+案件受理费+法务清收费+执行证书费+延迟履行金+保险费
（5）其他收入：取“核心-业务费用明细”字段：停车费+查档费+保险费+账户管理费+其他费用+风控抵押费用加成+风险管理费+GPS服务费+GPS费用
（6）平台费（一次性）：取“核心-业务费用明细”字段“平台费”
（7）平台月服务费：取“核心-业务费用明细”字段“月收平台费+团贷网平台费用(排除00期)”
（注：团贷网平台费用 取扣除掉00期的平台费）
(8)提前结清平台违约金:取“核心-业务费用明细”字段:提前结清平台服务费违约金+平台服务费违约金
（9）担保费：取“核心-业务费用明细”字段“担保费”+担保公司费用
（10）滞纳金：取“核心-业务费用明细”字段“线下滞纳金+线上滞纳金+滞纳金”
（11）逾期收入：取“核心-业务费用明细”字段“逾期收入”
*/


DROP TEMPORARY TABLE IF EXISTS tb_account_list_detail_tmp1;
CREATE TEMPORARY TABLE `tb_account_list_detail_tmp1` (
  `src_data` VARCHAR(4) NOT NULL DEFAULT '',
  `date_id` DATE DEFAULT NULL COMMENT '记账日期',
  `car_business_id` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '业务编号',
  `ext_business_id` VARCHAR(50) DEFAULT '' COMMENT '展期编号',
  `after_id` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '期数',
  `fee_name` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '费用名称',
  `action_id` INT(11) NOT NULL DEFAULT '0' COMMENT '交易活动',
  `account_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记账时间',
  `out_date` DATE DEFAULT NULL COMMENT '数据分割时间点',
  `business_type_nm` VARCHAR(50) DEFAULT '' COMMENT '业务类型',
  `branch_nm` VARCHAR(50) DEFAULT '' COMMENT '分公司id',
  `customer_name` VARCHAR(500) DEFAULT '' COMMENT '主客户名称',
  `settle_way` INT(1) NOT NULL DEFAULT '0' COMMENT '1表示结清 0表示未结清',
  `one_time_fgssr_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `one_time_ptf_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `one_time_dbf_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_fgssr_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_tqjqfgs_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_qtsr_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_ptf_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_tqjqpt_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_znj_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `mon_yqsr_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `drag_vist_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  `litigation_amt` DECIMAL(18,2) NOT NULL DEFAULT '0.00',
  KEY `idx_car_business_id` (`car_business_id`),
  KEY `idx_date_id` (`date_id`)
) ENGINE=INNODB DEFAULT CHARSET=utf8
;

/*非撤销的数据*/
INSERT INTO tb_account_list_detail_tmp1
SELECT 
 '正常数据' src_data
,t.account_date  AS date_id             --  [统计日期]   取核心中的记账日期 account_date                                              
,t.business_id   AS car_business_id     --  [业务编号]              
,t.exhibition_id AS ext_business_id     --  [展期业务编号] 
,t.after_id
,t.fee_name 
,t.action_id
,t.account_time        
,t.segmentation_date AS out_date            --  出款日期  取核心中的segmentation_date (目前线下和未知账户（不受这边影响）和 投资平台)               
,t.business_type AS business_type_nm    --  业务类型                 
,t.branch_name   AS branch_nm           --  业务所属分公司编号  
-- ,t.area_nm             --  区域编号                 
,t.main_customer_name AS customer_name       --  客户名称                           
-- ,t.shd_principa_amt    --  申请借款金额 
,t.settle_way  -- 1表示结清 0表示未结清    
,(CASE WHEN (t.fee_name='分公司服务费' AND t.after_id LIKE '%00%') OR (t.fee_name IN ('调查费','展期手续费','剩余前置服务费','行政综合费')) THEN t.amount ELSE 0 END) AS one_time_fgssr_amt  --  分公司收入(一次性)   
,(CASE WHEN t.fee_name IN ('平台费') THEN t.amount ELSE 0 END) AS one_time_ptf_amt    --  平台费(一次性)         
,(CASE WHEN t.fee_name IN ('担保费','担保公司费用') THEN t.amount ELSE 0 END) AS one_time_dbf_amt    --  担保费(一次性)         
,(CASE WHEN (t.fee_name='分公司服务费' AND t.after_id NOT LIKE '%00%') 
         OR (t.fee_name IN ('月收分公司服务费','月收分公司服务费(比例)','月收分公司服务费(金额)','逾期服务费','逾期分公司服务费','展期未结清服务费'))
         OR (t.fee_name='分公司费用' AND t.after_id NOT LIKE '%00%')
      THEN t.amount ELSE 0 END
 ) AS mon_fgssr_amt       --  分公司月服务费        
,(CASE WHEN (t.fee_name IN ('分公司月收服务费违约金','本金违约金','提前结清违约金','提前结清分公司服务费违约金','提前结清本金违约金')	)THEN t.amount ELSE 0 END) AS mon_tqjqfgs_amt     --  提前结清违约金        
,(CASE WHEN t.fee_name IN ('停车费','查档费','保险费','账户管理费','其他费用','风控抵押费用加成','风险管理费','GPS服务费','GPS费用') THEN t.amount ELSE 0 END)   AS mon_qtsr_amt        --  其他收入                 
,(CASE WHEN (t.fee_name='团贷网平台费用' AND t.after_id NOT LIKE '%00%') OR (t.fee_name IN ('月收平台费')) THEN t.amount ELSE 0 END)                         AS mon_ptf_amt         --  平台月服务费           
,(CASE WHEN t.fee_name IN ('提前结清平台服务费违约金','平台服务费违约金') THEN t.amount ELSE 0 END)                                                              AS mon_tqjqpt_amt      --  提前结清平台违约金  
,(CASE WHEN t.fee_name IN ('线下滞纳金','线上滞纳金','滞纳金') THEN t.amount ELSE 0 END) AS mon_znj_amt         --  滞纳金                    
,(CASE WHEN t.fee_name IN ('逾期收入') THEN t.amount ELSE 0 END)        AS mon_yqsr_amt        --  逾期收入  
,(CASE WHEN t.fee_name IN ('拖车费','上门费') THEN t.amount ELSE 0 END) AS drag_vist_amt --  拖车费上门费合计
,(CASE WHEN t.fee_name IN ('仲裁费','保全费','公告费','律师费','评估费','咨询费','诉讼费','鉴定费','案件受理费','法务清收费','执行证书费','迟延履行金','保险费') THEN t.amount ELSE 0 END) AS litigation_amt -- 诉讼发生费用合计            
FROM tb_account_list_detail_tmp  t
WHERE t.status_flag &lt;&gt;0
;
INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','2:非撤销的数据插入到tb_account_list_detail_tmp1', '0', '总共4步！！', 0,'${p_day}',  NOW(),  'caihl' );


INSERT INTO tb_account_list_detail_tmp1
SELECT 
 '撤销数据' src_data
,t.account_date  AS date_id             --  [统计日期]   取核心中的记账日期 account_date                                              
,t.business_id   AS car_business_id     --  [业务编号]              
,t.exhibition_id AS ext_business_id     --  [展期业务编号] 
,t.after_id
,t.fee_name 
,t.action_id
,t.account_time          
,t.segmentation_date AS out_date            --  出款日期  取核心中的segmentation_date (目前线下和未知账户（不受这边影响）和 投资平台)               
,t.business_type AS business_type_nm    --  业务类型                 
,t.branch_name   AS branch_nm           --  业务所属分公司编号  
-- ,t.area_nm             --  区域编号                 
,t.main_customer_name AS customer_name       --  客户名称                          
-- ,t.shd_principa_amt    --  申请借款金额  
,t.settle_way  -- 1表示结清 0表示未结清   
,-1 *(CASE WHEN (t.fee_name='分公司服务费' AND t.after_id LIKE '%00%') OR (t.fee_name IN ('调查费','展期手续费','剩余前置服务费','行政综合费')) THEN t.amount ELSE 0 END) AS one_time_fgssr_amt  --  分公司收入(一次性)   
,-1 *(CASE WHEN t.fee_name IN ('平台费') THEN t.amount ELSE 0 END) AS one_time_ptf_amt    --  平台费(一次性)         
,-1 *(CASE WHEN t.fee_name IN ('担保费','担保公司费用') THEN t.amount ELSE 0 END) AS one_time_dbf_amt    --  担保费(一次性)         
,-1 *(CASE WHEN (t.fee_name='分公司服务费' AND t.after_id NOT LIKE '%00%') 
         OR (t.fee_name IN ('月收分公司服务费','月收分公司服务费(比例)','月收分公司服务费(金额)','逾期服务费','逾期分公司服务费','展期未结清服务费'))
         OR (t.fee_name='分公司费用' AND t.after_id NOT LIKE '%00%')
      THEN t.amount ELSE 0 END
 ) AS mon_fgssr_amt       --  分公司月服务费        
,-1 *(CASE WHEN (t.fee_name IN ('分公司月收服务费违约金','本金违约金','提前结清违约金','提前结清分公司服务费违约金','提前结清本金违约金')	)THEN t.amount ELSE 0 END) AS mon_tqjqfgs_amt     --  提前结清违约金        
,-1 *(CASE WHEN t.fee_name IN ('停车费','查档费','保险费','账户管理费','其他费用','风控抵押费用加成','风险管理费','GPS服务费','GPS费用') THEN t.amount ELSE 0 END)   AS mon_qtsr_amt        --  其他收入                 
,-1 *(CASE WHEN (t.fee_name='团贷网平台费用' AND t.after_id NOT LIKE '%00%') OR (t.fee_name IN ('月收平台费')) THEN t.amount ELSE 0 END)                         AS mon_ptf_amt         --  平台月服务费           
,-1 *(CASE WHEN t.fee_name IN ('提前结清平台服务费违约金','平台服务费违约金') THEN t.amount ELSE 0 END)                                                              AS mon_tqjqpt_amt      --  提前结清平台违约金  
,-1 *(CASE WHEN t.fee_name IN ('线下滞纳金','线上滞纳金','滞纳金') THEN t.amount ELSE 0 END) AS mon_znj_amt         --  滞纳金                    
,-1 *(CASE WHEN t.fee_name IN ('逾期收入') THEN t.amount ELSE 0 END)        AS mon_yqsr_amt        --  逾期收入  
,-1 *(CASE WHEN t.fee_name IN ('拖车费','上门费') THEN t.amount ELSE 0 END) AS drag_vist_amt --  拖车费上门费合计
,-1 *(CASE WHEN t.fee_name IN ('仲裁费','保全费','公告费','律师费','评估费','咨询费','诉讼费','鉴定费','案件受理费','法务清收费','执行证书费','延迟履行金','保险费') THEN t.amount ELSE 0 END) AS litigation_amt -- 诉讼发生费用合计            
FROM tb_account_list_detail_tmp  t
WHERE t.status_flag =0
;

INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','3:撤销数据插入到tb_account_list_detail_tmp1', '0', '总共4步！！', 0,'${p_day}',  NOW(),  'caihl' );
/*
是否结清的判断规则：
1.和巧芬沟通，报表层展示 通过查询截止日期判断如果出现结清则该单为结清，(排除同一单+同一记账日期先结清后不结清的影响)
2.只在正常业务中判断是否结清（撤销数据不进行判断）
*/

ALTER TABLE DMA_SAL_ACHV_DATA.dma_sal_achv_fin_revenue_detail_fsd TRUNCATE PARTITION dma_sal_achv_fin_revenue_detail_fsd_${pt_day};
INSERT INTO DMA_SAL_ACHV_DATA.dma_sal_achv_fin_revenue_detail_fsd 
SELECT  
 t.src_data           --                         
,t.date_id            --  记账日期           
,t.car_business_id    --  业务编号           
,t.ext_business_id    --  展期编号           
,t.after_id           --  期数                 
,t.fee_name           --  费用名称           
,t.action_id          --  交易活动           
,t.account_time       --  记账时间           
,t.out_date           --  数据分割时间点  
,xd.business_type_nm         AS business_type_nm   --  业务类型
,IFNULL(xd.area_nm,'其他')   AS  area_nm           
,t.branch_nm          --  分公司            
,IFNULL(xd.customer_name,t.customer_name)   AS customer_name   -- 修复核心账务主借款人不正确情况
,xd.shd_principa_amt  -- 业务单借款总金额  
,t.settle_way         --                         
,t.one_time_fgssr_amt -- "分公司收入(一次性)"                         
,t.one_time_ptf_amt   -- "平台费(一次性)"                             
,t.one_time_dbf_amt   -- "担保费(一次性)"                             
,t.mon_fgssr_amt      -- 分公司月服务费                               
,t.mon_tqjqfgs_amt    -- 提前结清违约金                               
,t.mon_qtsr_amt       -- 其他收入                                     
,t.mon_ptf_amt        -- 平台月服务费                                 
,t.mon_tqjqpt_amt     -- 提前结清平台违约金                           
,t.mon_znj_amt        -- 滞纳金                                       
,t.mon_yqsr_amt       -- 逾期收入                                     
,t.drag_vist_amt      -- 拖车费上门费合计                             
,t.litigation_amt     -- 诉讼发生费用合计 
,'ht_cams' AS dw_src_sys                           # 来源系统  
,'tb_account_list_detail_cams_ods,dws_agr_xd_business,tb_department_ods' AS dw_src_tbl                           # 来源表    
,NOW()   AS dw_ins_tm                            # 插入时间  
,NOW()   AS dw_upd_tm                            # 更新时间  
,'caihl' AS dw_ins_usr                           # 插入用户  
,'caihl' AS dw_upd_usr                           # 更新用户 
, DATE_FORMAT('${pt_day}','%Y-%m-%d')	AS	part_dt	     --	分区日期              
FROM tb_account_list_detail_tmp1 t
LEFT JOIN (SELECT xd.business_id,xd.customer_name,xd.shd_principa_amt,xd.area_id,dep.dept_name AS area_nm
          ,(CASE WHEN xd.business_type IN ('房速贷标准件','房速贷非标准件','T600') THEN '房速贷'
		  WHEN xd.business_type IN ('车易贷','T500') THEN '车易贷'
		  WHEN xd.business_type IN ('T251') THEN '优房贷'
		  WHEN xd.business_type IN ('T170','T160') THEN '小微企业信用贷'
		  ELSE bt.business_type_nm	END ) AS business_type_nm    --	业务类型
         FROM DWS_DATA.dws_agr_xd_business xd 
         LEFT JOIN (SELECT a1.DEPT_ID,dept_name FROM ODS_XD_TUANDAI_BM.tb_department_ods a1
                   WHERE a1.part_dt=DATE_FORMAT('${pt_day}','%Y-%m-%d') 
                   ) dep ON xd.area_id = dep.DEPT_ID 
         LEFT JOIN DIM_DATA.`dim_prd_xd_business_type` bt ON xd.business_type = bt.business_type       
         WHERE xd.part_dt=DATE_FORMAT('${pt_day}','%Y-%m-%d')
         ) xd ON t.car_business_id = xd.business_id
WHERE (ABS(t.one_time_fgssr_amt)
+ ABS(t.one_time_ptf_amt  )
+ ABS(t.one_time_dbf_amt  )
+ ABS(t.mon_fgssr_amt     )
+ ABS(t.mon_tqjqfgs_amt   )
+ ABS(t.mon_qtsr_amt      )
+ ABS(t.mon_ptf_amt       )
+ ABS(t.mon_tqjqpt_amt    )
+ ABS(t.mon_znj_amt       )
+ ABS(t.mon_yqsr_amt      )
+ ABS(t.drag_vist_amt     )
+ ABS(t.litigation_amt    )) > 0
;


INSERT INTO public_data.tb_duty_detail_log
  (duty_id,duty_nm,duty_type, deal_nm,step_id, step_desc, row_cnt, state_dt,create_tm, create_usr)
VALUES
  ('${pt_dutyno}', '${p_duty_nm}','1','4:插入到目标表>>end', '0', '总共4步！！', 0,'${p_day}',  NOW(),  'caihl' );
</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>DMA_SAL_ACHV_DATA</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>688</xloc>
      <yloc>432</yloc>
    </entry>
    <entry>
      <name>SQL_LOG 120</name>
      <description/>
      <type>SQL</type>
      <sql>
insert into ods_state_log
  (duty_id,
   duty_nm,
   duty_type,
   deal_nm,
   step_id,
   step_desc,
   row_cnt,
   state_dt,
   create_tm,
   create_usr
   )
values
  ('${pt_dutyno}',
   '${p_duty_nm}',
	'1',
   'ktr_duty_check',
   '100',
   CONCAT('${pt_returnvalue}','  源表或依赖任务异常'),
   0,
   '${p_day}',
   NOW(),
   'dl'
	
  )</sql>
      <useVariableSubstitution>T</useVariableSubstitution>
      <sqlfromfile>F</sqlfromfile>
      <sqlfilename/>
      <sendOneStatement>F</sendOneStatement>
      <connection>public_data</connection>
      <parallel>N</parallel>
      <draw>Y</draw>
      <nr>0</nr>
      <xloc>576</xloc>
      <yloc>720</yloc>
    </entry>
  </entries>
  <hops>
    <hop>
      <from>START</from>
      <to>SQL_LOG 100</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>Y</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 400</from>
      <to>DUMMY</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>ktr_set_date</from>
      <to>SQL_LOG 200</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 310</from>
      <to>JavaScript_Return</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 100</from>
      <to>Set variables</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Set variables</from>
      <to>ktr_set_date</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 200</from>
      <to>ktr_duty_check</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>ktr_duty_check</from>
      <to>check_value</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>check_value</from>
      <to>SQL_LOG 210 2 2</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 210 2 2</from>
      <to>Java_cycle</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Java_cycle</from>
      <to>Wait for</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Wait for</from>
      <to>ktr_duty_check</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>ktr_duty_insert</from>
      <to>SQL_LOG 400</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>insert_data</from>
      <to>SQL_LOG 300</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>check_value</from>
      <to>insert_data</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>Java_cycle</from>
      <to>SQL_LOG 120</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 120</from>
      <to>JavaScript_Return</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>insert_data</from>
      <to>SQL_LOG 310</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>N</evaluation>
      <unconditional>N</unconditional>
    </hop>
    <hop>
      <from>SQL_LOG 300</from>
      <to>ktr_duty_insert</to>
      <from_nr>0</from_nr>
      <to_nr>0</to_nr>
      <enabled>Y</enabled>
      <evaluation>Y</evaluation>
      <unconditional>N</unconditional>
    </hop>
  </hops>
  <notepads>
    <notepad>
      <note>*************************							
功      能 ：dma_sal_achv_fin_revenue_detail_fsd
创建时间：20181203
创建人   ：caihl
源系统	 ：ht_cams
数据源表：
运行频率：天(存历史数据)
注意事项： 
问题发现： 
修改记录： 
***********************
caihl20181204 t.segmentation_date为空的数据也取
caihl20181225 延迟履行金 改成 迟延履行金 (陈丽萍说的)</note>
      <xloc>0</xloc>
      <yloc>0</yloc>
      <width>442</width>
      <heigth>219</heigth>
      <fontname>Microsoft YaHei UI</fontname>
      <fontsize>9</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>0</fontcolorred>
      <fontcolorgreen>0</fontcolorgreen>
      <fontcolorblue>0</fontcolorblue>
      <backgroundcolorred>192</backgroundcolorred>
      <backgroundcolorgreen>192</backgroundcolorgreen>
      <backgroundcolorblue>192</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <attributes>
    <group>
      <name>METASTORE.pentaho</name>
      <attribute>
        <key>Default Run Configuration</key>
        <value>{"namespace":"pentaho","id":"Default Run Configuration","name":"Default Run Configuration","description":"Defines a default run configuration","metaStoreName":null}</value>
      </attribute>
    </group>
    <group>
      <name>{"_":"Embedded MetaStore Elements","namespace":"pentaho","type":"Default Run Configuration"}</name>
      <attribute>
        <key>Pentaho local</key>
        <value>{"children":[{"children":[],"id":"server","value":null},{"children":[],"id":"clustered","value":"N"},{"children":[],"id":"name","value":"Pentaho local"},{"children":[],"id":"description","value":null},{"children":[],"id":"pentaho","value":"N"},{"children":[],"id":"readOnly","value":"Y"},{"children":[],"id":"sendResources","value":"N"},{"children":[],"id":"logRemoteExecutionLocally","value":"N"},{"children":[],"id":"remote","value":"N"},{"children":[],"id":"local","value":"Y"},{"children":[],"id":"showTransformations","value":"N"}],"id":"Pentaho local","value":null,"name":"Pentaho local","owner":null,"ownerPermissionsList":[]}</value>
      </attribute>
    </group>
  </attributes>
</job>
